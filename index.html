<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strategise for Personal Bests !</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
	
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-analytics-compat.js"></script>

	    <style>
                /* Apply Inter font and soothing background */
				    body {
        font-family: 'Inter', sans-serif;
        background-color: #ffffff; /* Clean white for a high-end, smooth look */
        color: #334155;
    }

        
        /* The "Soft Appearance" Domain Card Styles */
        .domain-card {
            transition: all 0.3s ease;
            border-radius: 1.5rem;
            border-width: 2px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05);
        }
        
        /* Pastel Palette */
        .domain-physical { background-color: #f0fff4; border-color: #c6f6d5; } /* Mint */
        .domain-productive { background-color: #fffaf0; border-color: #feebc8; } /* Peach */
        .domain-relational { background-color: #ebf8ff; border-color: #bee3f8; } /* Sky */
        .domain-cognitive { background-color: #f5f3ff; border-color: #e9d8fd; } /* Lavender */

        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Smooth scroll for "Canvas-First" navigation */
        html { scroll-behavior: smooth; }

        /* Cold-Spot Companion Input focus (Standard one-line logic) */
        .companion-input {
            touch-action: manipulation;
            font-size: 16px; /* Prevents auto-zoom on mobile */
        }

        #signInWrapper {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
/* Soothing Status Banner Styles */
/* Update this section in your <style> block */
#status-banner {
    min-height: 0; /* Changed from 20px so it doesn't leave a gap when empty */
    margin: 0 auto;
    border-radius: 12px;
    text-align: center;
    font-size: 0.9rem;
    border: 1px solid transparent;
    transition: all 0.4s ease;
}
 
/* Add this new helper class */
.banner-visible {
    opacity: 1 !important;
    padding: 14px !important;
}


.banner-success {
    background-color: #f0fdfa; /* Soft Seafoam */
    color: #134e4a;
    border-color: #ccfbf1;
}

.banner-info {
    background-color: #f0f9ff; /* Soft Sky Blue */
    color: #0c4a6e;
    border-color: #e0f2fe;
}

.banner-notice {
    background-color: #fffbeb; /* Soft Sand */
    color: #78350f;
    border-color: #fef3c7;
}
/* The "Deep Breath" Button Effect */
.slow-refill {
    pointer-events: none;
    cursor: wait;
    animation: refillOpacity 60s linear forwards;
}

@keyframes refillOpacity {
    0% {
        opacity: 0.3;
        filter: grayscale(1);
    }
    100% {
        opacity: 1;
        filter: grayscale(0);
    }
}

    </style>
	 
    <script src="https://unpkg.com/react@17/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
 
 <body>
 
 <div id="status-banner" class="max-w-sm mx-auto mt-2 mb-2"></div>
 <div id="resetFlowWrapper" style="display: none; min-height: 100vh; flex-direction: column; align-items: center; justify-content: center; background-color: #ffffff; padding: 40px 20px 20px 20px; gap: 10px;">

        <div id="reset-password-section" class="p-8 max-w-sm w-full bg-white rounded-2xl shadow-2xl border border-slate-100 text-center">
            <div class="mb-6">
                <div class="inline-block p-3 bg-indigo-50 rounded-full mb-4">
                    <span role="img" aria-label="shield" style="font-size: 2rem;">üõ°Ô∏è</span>
                </div>
                <h2 class="text-2xl font-extrabold text-slate-800">Secure Your Account</h2>
                <p class="text-sm text-slate-500 mt-2">Enter a new, strong password below to complete your reset.</p>
            </div>
            
            <div class="text-left">
                <label for="new-password" class="block text-sm font-medium text-slate-700 mb-1">New Password</label>
                <input type="password" id="new-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" 
                    class="w-full p-3 border border-slate-300 rounded-xl shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all mb-6 text-lg">
            </div>
            
            <button onclick="handlePasswordResetSubmit()" 
                class="w-full py-4 bg-indigo-600 text-white font-bold rounded-xl shadow-lg hover:bg-indigo-700 transition-all transform hover:scale-[1.01] active:scale-95">
                Update Password
            </button>
            
            <div class="mt-6">
                <a href="/" class="text-sm text-indigo-500 hover:text-indigo-700 font-medium transition-colors">
                    ‚Üê Back to Login
                </a>
            </div>
        </div>
    </div>

	 <div id="signInWrapper" style="display: none; min-height: 100vh; flex-direction: column; align-items: center; justify-content: center; padding: 40px 20px 20px 20px; gap: 10px;">
        <div class="p-8 max-w-sm w-full bg-white rounded-xl shadow-2xl text-center">
            <h1 class="text-3xl font-extrabold text-indigo-700 mb-6">Strategise for Personal Bests !</h1>
            
            <p id="authError" class="text-sm font-semibold text-red-600 mb-4"></p>
            
            <label for="emailInput" class="block text-left text-sm font-medium text-gray-700 mb-1">Email:</label>
            <input type="email" id="emailInput" required class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition-all mb-4">
            
            <label for="passwordInput" class="block text-left text-sm font-medium text-gray-700 mb-1">Password:</label>
            <input type="password" id="passwordInput" required class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition-all mb-6">
            
            <button id="signInButton" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl shadow-lg hover:bg-indigo-700 transition-colors transform hover:scale-[1.005] active:scale-98">
                Log In to Application
            </button>

            <button id="magicLinkButton" class="w-full py-3 mt-4 bg-teal-500 text-white font-bold rounded-xl shadow-lg hover:bg-teal-600 transition-colors transform hover:scale-[1.005] active:scale-98">
                Email Me a Magic Link
            </button>

            <div style="margin-top: 24px; font-size: 11px; color: #666; line-height: 1.5; border-top: 1px solid #f0f0f0; padding-top: 16px;">
               <p style="margin-bottom: 8px;">
                 A note from the publisher of this self-help resource ‚Äî <strong>Wise Whale Psychotherapy</strong>. 
                 <a href="mailto:connect@wisewhalepsychotherapy.com" style="color: #4A90E2; text-decoration: none;">connect@wisewhalepsychotherapy.com</a>.
               </p>
               <p>¬© 2026 WISE WHALE PSYCHOTHERAPY</p>
            </div>

            <div class="mt-8 px-4 leading-relaxed">
                <p class="text-[0.88rem] text-slate-600 font-normal tracking-tight">
                    When you‚Äôre ready to increase privacy, 
                    <span id="reset-link" 
                          class="underline cursor-pointer text-teal-600 font-medium transition-colors hover:text-teal-800"
                          onclick="handleReset()">
                        request password reset. 
                    </span>
                </p>
            </div>
        </div>
    </div>
    
    <div id="root" style="display: none;"></div>
	
    <script>
        
	 // --- 1. Firebase Configuration ---
const firebaseConfig = {
    apiKey: "AIzaSyAVoe4aDzGI4TyoNZNhFAi22mc2iCqAXic",
    authDomain: "cellular-axon-474111-r2.firebaseapp.com",
    projectId: "cellular-axon-474111-r2",
    storageBucket: "cellular-axon-474111-r2.firebasestorage.app",
    messagingSenderId: "745585089161",
    appId: "1:745585089161:web:dcede471d4a7bfd5b60458",
    measurementId: "G-JDV77ZHNP2"
};

// --- 2. Initialize Firebase (Safe Version) ---
const app = !firebase.apps.length ? firebase.initializeApp(firebaseConfig) : firebase.app();
const auth = firebase.auth();
const analytics = firebase.analytics();


// --- 3. The Interceptor (Password Reset Checker) ---
window.addEventListener('DOMContentLoaded', () => {
    const urlParams = new URLSearchParams(window.location.search);
    const mode = urlParams.get('mode');
    const actionCode = urlParams.get('oobCode');

    if (mode === 'resetPassword' && actionCode) {
        // Hide login, show the new centered reset wrapper
        const loginForm = document.getElementById('signInWrapper');
        const resetWrapper = document.getElementById('resetFlowWrapper');
        const resetSection = document.getElementById('reset-password-section');
        
        if (loginForm) loginForm.style.display = 'none';
        if (resetWrapper) {
            resetWrapper.style.display = 'flex'; // Uses flex to center everything
            resetSection.style.display = 'block';
        }
        
        window.tempActionCode = actionCode;
        console.log("Password reset mode detected.");
    }
});

// --- 4. User State and Listeners ---
let authenticatedUserId = null; 

auth.onAuthStateChanged((user) => {
    if (user) {
        authenticatedUserId = user.email;
        // User is signed in, handle dashboard logic here
    } else {
        authenticatedUserId = null;
        // User is signed out, handle login logic here
    }
});

        const signInWrapper = document.getElementById('signInWrapper');
        const rootElement = document.getElementById('root');
        const emailInput = document.getElementById('emailInput');
        const passwordInput = document.getElementById('passwordInput');
                const signInButton = document.getElementById('signInButton');
        const magicLinkButton = document.getElementById('magicLinkButton');
        const errorElement = document.getElementById('authError');

        // --- PASSWORD SIGN IN ---
        signInButton.addEventListener('click', async () => {
            const email = emailInput.value;
            const password = passwordInput.value;
            errorElement.textContent = ''; 

            if (!email || !password) {
                errorElement.textContent = 'Please enter both email and password.';
                return;
            }
            
            signInButton.disabled = true;

            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                signInButton.disabled = false;
                console.error("Sign-in error:", error.code);
                errorElement.textContent = 'Invalid email or password.';
            }
        });

        // --- MAGIC LINK SEND LOGIC ---
        magicLinkButton.addEventListener('click', async () => {
            const email = emailInput.value;
            errorElement.textContent = '';
            if (!email) {
                errorElement.textContent = 'Please enter your email first.';
                return;
            }
            const actionCodeSettings = {
    // Use your actual live domain here
    url: 'https://strategise.wisewhalepsychotherapy.com', 
    handleCodeInApp: true,
};

            try {
                await auth.sendSignInLinkToEmail(email, actionCodeSettings);
                window.localStorage.setItem('emailForSignIn', email);
                alert('Magic Link sent! Please check your inbox.');
            } catch (error) {
                errorElement.textContent = 'Error sending link. Please try again.';
            }
        });

        // --- MAGIC LINK HANDLER (ON LOAD) ---
        if (auth.isSignInWithEmailLink(window.location.href)) {
            let email = window.localStorage.getItem('emailForSignIn');
            if (!email) {
                email = window.prompt('Please confirm your email to complete sign-in:');
            }
            auth.signInWithEmailLink(email, window.location.href)
                .then(() => {
                    window.localStorage.removeItem('emailForSignIn');
                    window.history.replaceState({}, document.title, window.location.pathname);
                })
                .catch((error) => {
                    errorElement.textContent = 'The link has expired or already been used.';
                });
        }

        auth.onAuthStateChanged((user) => {
            if (user) {
                // User is signed in.
                authenticatedUserId = user.email;
                signInWrapper.style.display = 'none'; // Hide sign-in form
                rootElement.style.display = 'block'; // Show React App
                // Re-render the React app with the new user ID
                window.renderAppWithAuth(authenticatedUserId); 
            } else {
                // User is signed out.
                authenticatedUserId = null;
                signInWrapper.style.display = 'flex'; // Show sign-in form
                rootElement.style.display = 'none'; // Hide React App
                signInButton.disabled = false;
                
                // FIX 2: Reset email and password fields on sign-out
                emailInput.value = '';
                passwordInput.value = '';
            }
        });

        // --- Download Data Copy Logic (Outside of React for ease of use) ---
        // FIX 3: Updated download logic to retrieve all local storage keys associated with the user.
        window.downloadLocalData = function() {
            if (!authenticatedUserId) {
                alert("Cannot download data: User is not signed in.");
                return;
            }
            
            // Get all local storage keys for the signed-in user
            const dataPrefix = 'wise_whale_';
            const userSpecificKeys = Object.keys(localStorage).filter(key => 
                key.startsWith(dataPrefix)
            );
            
            const dataToDownload = {};

            userSpecificKeys.forEach(key => {
                try {
                    const data = localStorage.getItem(key);
                    // Attempt to parse to ensure it's valid JSON before adding
                    dataToDownload[key.replace(dataPrefix, '')] = JSON.parse(data);
                } catch (e) {
                    // If parsing fails, store as raw string or skip. Storing raw string for completeness.
                    dataToDownload[key.replace(dataPrefix, '')] = localStorage.getItem(key);
                }
            });

            // Check if any relevant data was found
            if (Object.keys(dataToDownload).length === 0) {
                alert('There‚Äôs no data to download, please ensure you have used the application!');
                return;
            }
            
            const dataString = JSON.stringify({
                userId: authenticatedUserId,
                downloadTimestamp: new Date().toISOString(),
                localData: dataToDownload
            }, null, 2); // Use 2-space indentation for readability

            const blob = new Blob([dataString], { type: 'application/json' }); 
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            
            const date = new Date().toISOString().slice(0, 10).replace(/-/g, '');
            // Include user part of email in filename
            const userHandle = authenticatedUserId.split('@')[0];
            a.download = `StrategiseData-${userHandle}-${date}.json`; 
            
            document.body.appendChild(a);
            a.click();
            
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            console.log('Local data download initiated.');
        };
        
        // Expose the sign out function globally so the React app can call it
        window.signOutUser = function() {
            auth.signOut().then(() => {
                // Sign-out successful. The onAuthStateChanged listener will update the UI.
            }).catch((error) => {
                console.error("Sign Out Error:", error);
            });
        };
		
		// Function to display the softened banner
		function showStatus(text, type) {
    const banner = document.getElementById('status-banner');
    if (!banner) return;

    banner.innerText = text;
    
    // Structure: w-full for mobile, max-w-sm to match your cards, p-4 for 'meat'
    banner.className = 'w-full max-w-sm mx-auto my-4 p-4 rounded-xl text-center block shadow-sm'; 
    
    // Theme
    banner.classList.add('banner-' + type);
    
    // Visibility
    banner.style.opacity = '1';
    
    // Optional: Auto-scroll so the user sees the message
    window.scrollTo({ top: 0, behavior: 'smooth' });
}


// The "Slow Progression" Reset Logic
function handleReset() {
    // Sync: using 'emailInput' to match your global variable defined above
    const emailField = document.getElementById('emailInput'); 
    const link = document.getElementById('reset-link');

    if (!emailField || !emailField.value) {
        showStatus("Please enter your email above to begin this step.", "notice");
        return;
    }

    showStatus("Preparing your privacy reset link...", "info");

    auth.sendPasswordResetEmail(emailField.value)
        .then(() => {
            showStatus("Link sent. Take a deep breath and check your inbox.", "success");
            
            // Start the 60-second "Slow Progression" visual
            if (link) link.classList.add('slow-refill');

            setTimeout(() => {
                if (link) link.classList.remove('slow-refill');
                showStatus("Reset link is available again if needed.", "info");
            }, 60000);
        })
        .catch((error) => {
            // Mapping Firebase errors to softer language
            let message = error.message;
            if (error.code === 'auth/user-not-found') message = "Email not found. Please check the spelling.";
            
            showStatus("Notice: " + message, "notice");
            if (link) link.classList.remove('slow-refill'); 
        });
}  

// --- 5. The Missing Link: Submit the New Password ---
window.handlePasswordResetSubmit = async function() {
    // We grab the elements directly inside the function to ensure we have the current values
    const passwordField = document.getElementById('new-password');
    const newPassword = passwordField ? passwordField.value : '';
    const actionCode = window.tempActionCode; 

    if (!newPassword || newPassword.length < 6) {
        showStatus("Please enter a password of at least 6 characters.", "notice");
        return;
    }

    if (!actionCode) {
        showStatus("Session expired or invalid link. Please request a new reset link.", "notice");
        return;
    }

    try {
        // Explicitly use the auth object we initialized earlier
        await firebase.auth().confirmPasswordReset(actionCode, newPassword);
        
        showStatus("Success! Your password has been updated. Redirecting to login...", "success");

        setTimeout(() => {
            // Clears the URL parameters and reloads to the clean login page
            window.location.href = window.location.origin + window.location.pathname;
        }, 2500);

    } catch (error) {
        console.error("Reset Error:", error);
        let friendlyMessage = "Link expired or already used. Please try again.";
        if (error.code === 'auth/weak-password') friendlyMessage = "That password is too weak.";
        if (error.code === 'auth/invalid-action-code') friendlyMessage = "The reset link is invalid or expired.";
       
        showStatus(friendlyMessage, "notice");
    }
}


    </script>


    <script type="text/babel">
    const { useState, useEffect, useCallback, useMemo, useRef } = React;
    
    // --- LOCAL STORAGE UTILITIES ---
    const DEFAULT_USER_ID = 'wise_whale_local_client';
    const LOCAL_STORAGE_PREFIX = 'wise_whale_';
    
    // ... (rest of your original Local Storage Utilities remain unchanged) ...

    const saveToLocal = (key, data) => {
        try {
            localStorage.setItem(LOCAL_STORAGE_PREFIX + key, JSON.stringify(data));
        } catch (error) {
            console.error("Error saving to Local Storage:", error);
        }
    };

    const loadFromLocal = (key, defaultValue = null) => {
        try {
            const stored = localStorage.getItem(LOCAL_STORAGE_PREFIX + key);
            return stored ? JSON.parse(stored) : defaultValue;
        } catch (error) {
            console.error("Error loading from Local Storage:", error);
            return defaultValue;
        }
    };
    
    const removeLocal = (key) => {
        try {
            localStorage.removeItem(LOCAL_STORAGE_PREFIX + key);
        } catch (error) {
            console.error("Error removing from Local Storage:", error);
        }
    };

    // --- Business Details & States ---
    const BUSINESS_DETAILS = {
        name: "WISE WHALE PSYCHOTHERAPY",
        email: "connect@wisewhalepsychotherapy.com",
        address: "Gold Coast Queensland Australia 4215",
        website: "https://wisewhalehypnotherapy.wisewhalepsychotherapy.com/",
        copyright: "Copyright ¬©Ô∏è WISE WHALE PSYCHOTHERAPY 2026. All rights reserved."
    };
    
	    const SCREENS = {
        WELCOME: 'welcome', 
        PROFILE_QUESTIONS: 'profileQuestions', 
        GOAL_GUIDANCE: 'goalGuidance', 
        STRATEGY_SUMMARY: 'strategySummary', 
        FULL_STRATEGY_BUILDER: 'fullStrategyBuilder',
    };

    const initialActionState = { 
        summary: '', 
        easy: '', 
        hard: '', 
        helpful: '', 
        pleased: null, 
        goalAlignmentEvaluation: '' 
    };
    
    // Updated STRATEGY_CONTENT with specific guidance text
    const STRATEGY_CONTENT = {
        'Physical Flow': { 
            title: 'Physical Flow', color: 'bg-green-100', text: 'text-green-800', border: 'border-green-400', key: 'physicalFlow',
            guidance: "Focus on your relationship with your body, movement, and environment. Think about kinetic awareness and daily rhythms."
        },
            'Productive & Creative Currents': { 
        title: 'Productive & Creative Currents', 
        color: 'bg-amber-50', // Softened from yellow to amber wash
        text: 'text-amber-700', // The "Golden" professional heading color
        border: 'border-amber-300', 
        key: 'productiveCreative',
        guidance: "Address time management, priorities, and channeling energy into meaningful work or creative expression."
    },
        'Tidal Connections of Inter/Intrapersonal Relationships': { 
            title: 'Tidal Connections of Inter/Intrapersonal Relationships', color: 'bg-blue-100', text: 'text-blue-800', border: 'border-blue-400', key: 'tidalConnections',
            guidance: "Define relational goals, boundaries, communication, and balancing connection with personal space."
        },
        'Cognitive & Mental Depth & Agility': { 
            title: 'Cognitive & Mental Depth & Agility', color: 'bg-indigo-100', text: 'text-indigo-800', border: 'border-indigo-400', key: 'cognitiveMental',
            guidance: "Focus on metacognition, emotional regulation, managing stress, and developing mental resilience."
        },
    };

    const getInitialDomainState = (title, key) => ({
        domainTitle: title,
        domainKey: key,
        title: '', 
        successCriteria: '', 
        forecastScenerySensory: '', 
        effects: '',
        actions: [
            { ...initialActionState, id: 1, label: 'Action 1: Define what you will do.' },
            { ...initialActionState, id: 2, label: 'Action 2: Define what you will do.' },
            { ...initialActionState, id: 3, label: 'Action 3: Define what you will do.' },
        ],
        dailyChecklist: { mon: false, tue: false, wed: false, thu: false, fri: false, sat: false, sun: false },
    });
    
    const getInitialStrategyState = () => ({
        preferredName: '',
        themeTitle: '',
        date: new Date().toISOString().substring(0, 10), 
        transitionalGoal: { current: '', potential: '', position: '' },
        domains: {
            physicalFlow: getInitialDomainState(STRATEGY_CONTENT['Physical Flow'].title, STRATEGY_CONTENT['Physical Flow'].key),
            productiveCreative: getInitialDomainState(STRATEGY_CONTENT['Productive & Creative Currents'].title, STRATEGY_CONTENT['Productive & Creative Currents'].key),
            tidalConnections: getInitialDomainState(STRATEGY_CONTENT['Tidal Connections of Inter/Intrapersonal Relationships'].title, STRATEGY_CONTENT['Tidal Connections of Inter/Intrapersonal Relationships'].key),
            cognitiveMental: getInitialDomainState(STRATEGY_CONTENT['Cognitive & Mental Depth & Agility'].title, STRATEGY_CONTENT['Cognitive & Mental Depth & Agility'].key),
        },
        monitoring: {
            weeklyReflection: '',
        }
    });

	    const WiseWhaleLogo = () => (
        <div className="flex justify-center mb-6 pt-4">
            <div className="relative group">
                {/* Sunlight Glow: Warm Amber/Gold instead of Grey */}
                <div className="absolute inset-0 bg-amber-200 blur-3xl rounded-full scale-125 opacity-40 animate-pulse"></div>
                <img 
                    src="https://i.postimg.cc/Bvfx0Ywz/IMG-1424.png" 
                    alt="Personal Bests Icon" 
                    className="relative w-32 h-32 md:w-36 md:h-36 object-contain rounded-full border-2 border-white shadow-lg bg-white"
                    style={{ imageRendering: 'high-quality' }} // Extra boost for sharpness
                />
            </div>
        </div>
    );

    
    const InputField = ({ label, type = 'text', value, onChange, required, maxLength, placeholder, rows = 1, name, placeholderColor = 'placeholder-gray-400' }) => (
        <div className="mb-4">
            <label className="block text-left text-sm font-medium text-gray-700 mb-1">{label}</label>
            {rows > 1 ? (
                <textarea
                    name={name}
                    rows={rows}
                    value={value || ''}
                    onChange={onChange}
                    required={required}
                    maxLength={maxLength}
                    placeholder={placeholder}
                    className={`w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition-all resize-y ${placeholderColor}`}
                />
            ) : (
                <input
                    type={type}
                    name={name}
                    value={value || ''}
                    onChange={onChange}
                    required={required}
                    maxLength={maxLength}
                    placeholder={placeholder}
                    className={`w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition-all ${placeholderColor}`}
                />
            )}
        </div>
    );

    const TextAreaField = (props) => <InputField {...props} rows={props.rows || 3} type="textarea" />;
    
    // --- NEW: Welcome Screen Component (Reduced content as main content moved) ---
    const WelcomeScreen = ({ userId, onNext }) => {
        const [strategyInfo, setStrategyInfo] = useState(loadFromLocal(`strategyData_${userId}`, getInitialStrategyState()));
        
        const handleChange = (e) => {
            const { name, value } = e.target;
            setStrategyInfo(prev => ({
                ...prev,
                [name]: value
            }));
        };

        const handleNext = () => {
            saveToLocal(`strategyData_${userId}`, strategyInfo);
            onNext();
        }

        return (
            <div className="p-4 sm:p-8 max-w-4xl mx-auto bg-white rounded-xl shadow-2xl">
				    const WiseWhaleLogo = () => (
        <div className="flex justify-center mb-6 pt-4">
            <div className="relative group">
                {/* Sunlight Glow: Warm Amber/Gold instead of Grey */}
                <div className="absolute inset-0 bg-amber-200 blur-3xl rounded-full scale-125 opacity-40 animate-pulse"></div>
                <img 
                    src="https://i.postimg.cc/Bvfx0Ywz/IMG-1424.png" 
                    alt="Personal Bests Icon" 
                    className="relative w-32 h-32 md:w-36 md:h-36 object-contain rounded-full border-2 border-white shadow-lg bg-white"
                    style={{ imageRendering: 'high-quality' }} // Extra boost for sharpness
                />
            </div>
        </div>
    );

   
                <h2 className="text-2xl font-bold text-gray-700 mb-4 border-b pb-2">Your Initial Focus</h2>
                <InputField
                    label="Your Preferred Name:"
                    name="preferredName"
                    value={strategyInfo.preferredName}
                    onChange={handleChange}
                    placeholder="Enter the name you'd like to be called."
                    rows={1}
                />
                <InputField
                    label="Title: Overall Theme of Transition you‚Äôd like to focus on:"
                    name="themeTitle"
                    value={strategyInfo.themeTitle}
                    onChange={handleChange}
                    placeholder="E.g., Career Change, Health Focus, Boundary Setting, Finding Flow."
                    rows={1}
                />
                <InputField
                    label="Date:"
                    name="date"
                    type="date"
                    value={strategyInfo.date}
                    onChange={handleChange}
                    placeholder=""
                    rows={1}
                />
                
                <p className="text-sm text-gray-500 mt-8 mb-4">
                    *(These details will populate your Strategise Dashboard.)*
                </p>

                <button 
                    onClick={handleNext}
                    className="w-full py-4 mt-4 bg-indigo-600 text-white font-bold rounded-xl shadow-lg hover:bg-indigo-700 transition-colors transform hover:scale-[1.005] active:scale-98"
                >
                    Dive into the Strategy Dashboard &rarr;
                </button>

                {/* Simplified Legal Footer for this screen */}
                <div className="mt-8 pt-6 border-t border-gray-200 text-center text-xs text-gray-500 space-y-2">
                    <p>{BUSINESS_DETAILS.copyright}</p>
                </div>
            </div>
        );
    };

    const profileQuestionsStructure = {
        hotspots: [
            { key: 'freshAir', label: 'Where do you go for fresh air and a fulfilling breath?' },
            { key: 'sunlitPlaces', label: 'What are your favorite sunlit places in the morning, noon, and night?' },
            { key: 'positiveRoutine', label: 'What positive routines or habits do you maintain consistently?' },
            { key: 'emotionalSupport', label: 'Who or what provides you with genuine emotional support and safety?' },
            { key: 'physicalActivity', label: 'What physical activity or movement brings you joy and energy?' },
            { key: 'mindfulPractices', label: 'Which mindful practices (meditation, breathing, etc.) help you ground yourself?' },
            { key: 'creativeOutlets', label: 'What creative outlets or hobbies allow you to express yourself freely?' },
            { key: 'safeSpaces', label: 'Describe your most secure and comforting physical environment (safe space).' },
            { key: 'selfCompassion', label: 'In what ways do you consistently show yourself kindness and self-compassion?' },
            { key: 'meaningfulWork', label: 'What aspects of your work or daily tasks feel purposeful and meaningful?' },
            { key: 'qualitySleep', label: 'What conditions help you achieve quality, restorative sleep?' },
            { key: 'nutritiousFood', label: 'What types of nutritious foods do you prioritize for energy and well-being?' },
            { key: 'natureConnection', label: 'How and where do you connect with nature or the outdoors?' },
            { key: 'financialStability', label: 'What aspects of your financial situation provide you with stability and peace of mind?' },
            { key: 'personalBoundaries', label: 'How do you successfully set and maintain healthy personal boundaries?' },
            { key: 'learningGrowth', label: 'What new skills or knowledge are you actively pursuing for personal growth?' },
            { key: 'spiritualPractices', label: 'Do you have any spiritual or philosophical practices that offer guidance and peace?' },
            { key: 'playfulnessHumor', label: 'Where and when do you allow yourself to be playful and use humor?' },
            { key: 'timeManagement', label: 'What strategies do you use that effectively help you manage your time and priorities?' },
            { key: 'conflictResolution', label: 'How do you approach and successfully resolve interpersonal conflicts?' },
            { key: 'gratitudePractices', label: 'In what form do you practice gratitude or appreciation regularly?' },
            { key: 'restoredEnergy', label: 'What specific activity or person most reliably helps you restore depleted energy?' },
        ],
        coldspots: [
            { key: 'gossip', label: 'Gossip' },
            { key: 'deviceUse', label: 'Device use (excessive or mindless scrolling)' },
            { key: 'procrastination', label: ' Procrastination or avoidance of necessary tasks' },
            { key: 'negativeSelfTalk', label: 'Negative or highly critical self-talk' },
            { key: 'socialWithdrawal', label: 'Excessive social withdrawal or isolation' },
            { key: 'perfectionism', label: 'Paralyzing perfectionism or fear of failure' },
            { key: 'comparisonTrap', label: 'Comparing yourself negatively to others (comparison trap)' },
            { key: 'unhealthyFood', label: 'Consuming unhealthy food or excessive substances' },
            { key: 'sleepDeprivation', label: 'Chronic sleep deprivation or inconsistent sleep schedule' },
            { key: 'clutterDisorganization', label: 'Physical clutter or constant disorganization in your environment' },
            { key: 'unclearBoundaries', label: 'Difficulty setting boundaries, leading to being overextended' },
            { key: 'avoidingConflict', label: 'Avoiding necessary confrontation or conflict resolution' },
            { key: 'financialStress', label: 'Chronic financial worry or impulse spending' },
            { key: 'lackOfPurpose', label: 'Feeling a significant lack of direction or purpose' },
            { key: 'overcommitment', label: 'Taking on too many responsibilities (overcommitment)' },
            { key: 'rumination', label: 'Excessive rumination or worry about past events or the future' },
        ]
    };
    
    // ... (rest of ProfileQuestionsScreen, GoalGuidanceScreen, JournalQuestionsModal remain unchanged) ...

    const ProfileQuestionsScreen = ({ userId, onNext }) => {
        const initialState = { hotspots: {}, coldspots: {} };
        profileQuestionsStructure.hotspots.forEach(q => initialState.hotspots[q.key] = '');
        profileQuestionsStructure.coldspots.forEach(q => initialState.coldspots[q.key] = '');
        
        const loadedData = loadFromLocal(`profileData_${userId}`, initialState);
        const [profileData, setProfileData] = useState(loadedData);
        
        const [isSaving, setIsSaving] = useState(false);
        const [saveError, setSaveError] = useState(null);
// --- REAL-TIME AUTO-SAVE (PROFILE DRAFTS) ---
    useEffect(() => {
        if (userId && profileData) {
            saveToLocal(`profileData_${userId}`, profileData);
        }
    }, [profileData, userId]);
        const handleChange = (section, key, value) => {
            setProfileData(prev => ({
                ...prev,
                [section]: {
                    ...prev[section],
                    [key]: value
                }
            }));
        };

        const handleSave = (e) => {
            e.preventDefault();
            setIsSaving(true);
            setSaveError(null);
            
            try {
                const dataToSave = { 
                    ...profileData, 
                    submissionTimestamp: new Date().toISOString(),
                    recordType: "Initial Intake Profile"
                };
                
                saveToLocal(`profileData_${userId}`, dataToSave);
                
                setTimeout(() => {
                    setIsSaving(false);
                    onNext(); 
                }, 500);

            } catch (error) {
                console.error("Error writing profile document: ", error);
                setSaveError(`Failed to save data. Error: ${error.message}`);
                setIsSaving(false);
            }
        };

        return (
            <div className="p-4 sm:p-8 max-w-4xl mx-auto bg-white rounded-xl shadow-2xl">
        <div className="flex justify-center mb-6 pt-4">
            <div className="relative group">
                {/* Sunlight Glow: Warm Amber/Gold instead of Grey */}
                <div className="absolute inset-0 bg-amber-200 blur-3xl rounded-full scale-125 opacity-40 animate-pulse"></div>
                <img 
                    src="https://i.postimg.cc/Bvfx0Ywz/IMG-1424.png" 
                    alt="Personal Bests Icon" 
                    className="relative w-32 h-32 md:w-36 md:h-36 object-contain rounded-full border-2 border-white shadow-lg bg-white"
                    style={{ imageRendering: 'high-quality' }} // Extra boost for sharpness
                />
            </div>
        </div>

	         {/* Centered Heading and Intro */}
    <div className="text-center mb-10">
        <h1 className="text-4xl font-extrabold text-blue-800 mb-4 border-b-2 border-blue-50 pb-4 inline-block">
            Profile: Your Inner Seas Map üêã
        </h1>
        <p className="text-gray-600 max-w-2xl mx-auto leading-relaxed mt-4">
            This categorical section helps you build a <strong>definitive self-awareness map</strong>. 
            By charting your energy decisively, and with authority, you can navigate your journey with 
            greater wisdom. <span className="italic text-sm text-slate-400 block mt-2">(Data is stored only on this browser/device.)</span>
        </p>
    </div>
	
    {/* Identity & Theme Anchor */}
    <div className="mb-10 p-6 bg-slate-50 rounded-2xl border-2 border-slate-100 shadow-inner">
        <h2 className="text-xl font-bold text-slate-700 mb-4">Identity & Theme</h2>
        <InputField
            label="Your Preferred Name:"
            value={profileData.preferredName || ''}
            onChange={(e) => setProfileData({...profileData, preferredName: e.target.value})}
            placeholder="How shall we address you?"
        />
        <InputField
            label="Overall Theme of Transition:"
            value={profileData.themeTitle || ''}
            onChange={(e) => setProfileData({...profileData, themeTitle: e.target.value})}
            placeholder="E.g., Career Change, Health Focus..."
        />
    </div>

                <form onSubmit={handleSave}>
                    <div className="bg-green-50 p-6 rounded-xl shadow-inner mb-10 border border-green-200">
                        <h2 className="text-3xl font-bold text-green-700 mb-4">Hotspots (Energy & Deep Support)</h2>
                        <p className="text-gray-700 italic mb-4">These are the currents that lift you. Describe them in detail to anchor their power.</p>
                        {profileQuestionsStructure.hotspots.map(({ key, label }) => (
                            <TextAreaField 
                                key={key} 
                                label={label} 
                                value={profileData.hotspots[key]} 
                                onChange={(e) => handleChange('hotspots', key, e.target.value)} 
                                placeholder="Your response here‚Äîthe more detail, the clearer the water." 
                                placeholderColor="placeholder-green-600/70"
                                rows={2}
                            />
                        ))}
                    </div>

                    <div className="bg-red-50 p-6 rounded-xl shadow-inner border border-red-200">
                        <h2 className="text-3xl font-bold text-red-700 mb-4">Cold-spots (Obstacles & Energy Drain) </h2>
                        <p className="text-gray-700 italic mb-4">Identify the anchors or leaks. Recognising them is the first step to lifting them.</p>
                        {profileQuestionsStructure.coldspots.map(({ key, label }) => (
                             <TextAreaField 
                                key={key} 
                                label={`Do you detect and would like to eradicate: ${label}?`} 
                                value={profileData.coldspots[key]} 
                                onChange={(e) => handleChange('coldspots', key, e.target.value)} 
                                placeholder="Yes/No, and briefly describe the obstacle or how it shows up in your day." 
                                placeholderColor="placeholder-red-600/70"
                                rows={1}
                            />
                        ))}
                    </div>
                    
                    {saveError && <div className="mt-6 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg"><p className="font-semibold">Save Error:</p><p className="text-sm">{saveError}</p></div>}

                    <button 
                        type="submit"
                        disabled={isSaving || !userId}
                        className={`w-full py-4 mt-8 text-white font-bold rounded-xl shadow-lg transition-all transform hover:scale-[1.005] ${
                            isSaving || !userId ? 'bg-gray-400 cursor-not-allowed' : 'bg-indigo-600 hover:bg-indigo-700 active:scale-98'
                        }`}
                    >
                        {isSaving ? 'Charting Your Course...' : 'Save Map & Continue to Goal Guide ‚Üí'}
                    </button>
                </form>
            </div>
        );
    };

	
	    const GoalGuidanceScreen = ({ onNext }) => {
        const smartGoals = ['Specific', 'Measurable', 'Achievable', 'Relevant', 'Time-bound'];
        const dispositions = ['Resilience', 'Emotional Strength', 'Resourcefulness', 'Cognitive Capabilities', 'Reflection', 'Strategic Awareness', 'Relating', 'Social Sophistication'];
        const tips = [
            { heading: "Use your Wise Voice", body: "Be realistic. Describe goals with predictive and permissive sentences. Example: 'I'm predicting increased tenacity gradually over the next few weeks.'" },
            { heading: "Anchor Tasks and Context", body: "Specify the task, location, and timeframe. Example: 'I will prepare for willpower by setting my alarm earlier to acknowledge my objectives.'" },
            { heading: "Forecast for Breaks", body: "Plan for micro-breaks. A moment to breathe (like the whale) and time in nature allows for mental processing." },
            { heading: "Clarify Coping Steps", body: "Start with mechanisms you're already aware of, then allow space for other possibilities to emerge." },
            { heading: "Prioritize Balance", body: "Create lifestyle balance. If you notice strengths in one domain, leverage that same 'oomph' in others." }
        ];

        return (
            <div className="p-4 sm:p-8 max-w-4xl mx-auto bg-white rounded-xl shadow-2xl text-center">
                <div className="flex justify-center mb-6">
                    <WiseWhaleLogo />
                </div>
                
                <h1 className="text-4xl font-extrabold text-blue-800 mb-6 border-b pb-2">Author's Note & Philosophy</h1>
                
                <div className="text-lg italic text-gray-700 leading-relaxed space-y-4 mb-10 text-left px-4">
                    <p>My philosophy is simple: Everybody can find purpose and fulfillment in pursuit of taking good care. This commitment to self-stewardship is realized across the four key domains of human function: our physical, mental, relational, and creative/productive experiences.</p>
                    <p>True insight requires separating and recognizing your subconscious thoughts, conscious actions, inner landscape, outer world, memories, and future foresight.</p>
                    <p>By consistently exercising all parts of ourselves, we tone, improve, and maintain them and instill a sense of value. Aiming for your Personal Best's in these areas provides the clear, infinite direction for progress.</p>
                </div>

                <div className="mb-10 p-6 bg-blue-50 rounded-lg border-l-4 border-blue-400 text-left">
                    <h2 className="text-2xl font-bold text-blue-700 mb-4">The S.M.A.R.T. Framework</h2>
                    <ul className="space-y-2">
                        {smartGoals.map((goal, index) => (
                            <li key={index} className="text-gray-700 font-semibold flex items-center">
                                <span className="text-blue-500 mr-3 text-xl">‚Ä¢</span> {goal}
                            </li>
                        ))}
                    </ul>
                </div>
                
                <div className="mb-10 p-6 bg-green-50 rounded-lg border-l-4 border-green-400 text-left">
                    <h2 className="text-2xl font-bold text-green-700 mb-4">Developing Core Dispositions</h2>
                    <div className="grid grid-cols-2 gap-y-3 gap-x-2 text-sm font-medium text-green-800">
                        {dispositions.map((d, index) => (
                            <div key={index} className="flex items-center">
                                <span className="text-green-500 mr-2">‚úì</span> {d}
                            </div>
                        ))}
                    </div>
                </div>

                <div className="mb-10 p-6 bg-yellow-50 rounded-lg border-l-4 border-yellow-400 text-left">
                    <h2 className="text-2xl font-bold text-yellow-700 mb-4">Wise Planning Tips</h2>
                    <ul className="space-y-6">
                        {tips.map((tip, index) => (
                            <li key={index} className="text-gray-700 border-b pb-2 last:border-b-0">
                                <h4 className="text-lg font-bold text-yellow-700 mb-1">{tip.heading}</h4>
                                <p className="ml-2">{tip.body}</p>
                            </li>
                        ))}
                    </ul>
                </div>

                <button 
                    onClick={onNext}
                    className="w-full py-4 mt-8 bg-indigo-600 text-white font-bold rounded-xl shadow-lg hover:bg-indigo-700 transition-all"
                >
                    I'm Ready to Define My Strategy Canvas
                </button>
            </div>
        );
    };


    const JournalQuestionsModal = ({ onClose }) => {
        const observationQuestions = [
            'Use of internal dialogue (Was it helpful, harsh, or curious?)',
            'Your tolerance for ambiguity, frustration, or discomfort (Did you breathe through it?)',
            'Biases identified, times you acted outside of your comfort zone and found the experience more/less comfortable than expected',
            'Insights gained from participating',
            'Times of Pessimism vs. Optimism (What was the balance?)',
            'Times of Positive vs. Negative expectations (Did you allow for the positive?)',
            'Do you easily recognise Self vs. Others Orientation (Are you over-giving/under-giving?)',
            'Do you see things as Similarities vs. Differences',
            'Visual vs. Kinesthetic vs. Auditory (How did you primarily process information?)',
            'Can you recognise different frame of reference‚Äîemotional, thinking, imaginative, internal, and external.',
            'Do you recognise when you are generalizing v‚Äôs developing beliefs from external evidence.', 
            'Distortion (Did your mind jump to conclusions?)',
            'Deletion (What did you unconsciously leave out?)',
            'In your zone is it more helpful to Abstract vs. Concrete',
            'To Avoid vs. Pro-activity',
            'Are you taking an All or nothing view vs. Options',
            'What are good times to be Focused vs. Diffused',
        ];

        const checkInQuestions = [
            'Are= you able to achieve the action again, consistently? If not, what small adjustment is needed?',
            'Are there any steps you would take out for good reason?',
            'Have your actions developed a stronger sense of how you manage your internal and external worlds?',
            "Is looking at the details separately helping you approach life with greater understanding and enjoyment?",
            'Are you going to keep going? What motivates your next breath?',
            'What self-observation would indicate you\'re due for a fresh challenge?',
            'Where to now? What is the next clear water you want to swim into?',
        ];

        return (
            <div className="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-start justify-center p-4 z-50 overflow-y-auto">
                <div className="bg-white rounded-xl shadow-3xl max-w-3xl w-full my-8 p-6 sm:p-8">
                    <div className="flex justify-between items-center border-b pb-3 mb-4">
                        <h2 className="text-3xl font-extrabold text-indigo-700">Wise Whale Weekly Reflection Guide</h2>
                        <button 
                            onClick={onClose}
                            className="text-gray-500 hover:text-gray-800 transition-colors text-3xl font-light"
                        >
                            &times;
                        </button>
                    </div>

                    <div className="mb-8 p-4 bg-purple-50 rounded-lg border-l-4 border-purple-400">
                        <h3 className="text-xl font-bold text-purple-700 mb-3">Self-Observation of Engagement & Evaluations</h3>
                        <ul className="space-y-3">
                            {observationQuestions.map((q, index) => (
                                <li key={`obs-${index}`} className="text-gray-700 flex items-start">
                                    <span className="text-purple-500 mr-2 mt-1">‚Ä¢</span> {q}
                                </li>
                            ))}
                        </ul>
                    </div>

                    <div className="p-4 bg-teal-50 rounded-lg border-l-4 border-teal-400">
                        <h3 className="text-xl font-bold text-teal-700 mb-3">A Final Check-in: Self-Expansion</h3>
                        <ul className="space-y-3">
                            {checkInQuestions.map((q, index) => (
                                <li key={`check-${index}`} className="text-gray-700 flex items-start">
                                    <span className="text-teal-500 mr-2 mt-1">‚Ä¢</span> {q}
                                </li>
                            ))}
                        </ul>
                        <p className="text-sm italic text-gray-500 mt-4 font-semibold">
                            You‚Äôve really explored your strengths, goals, and possibilities today! Well done.
                            Remember: the Wise Whale within you knows the way to clearer waters.
                        </p>
                    </div>

                    <div className="mt-8 text-center">
                        <button 
                            onClick={onClose}
                            className="w-full sm:w-1/2 py-3 bg-indigo-600 text-white font-bold rounded-xl shadow-lg hover:bg-indigo-700 transition-colors transform hover:scale-[1.01] active:scale-98"
                        >
                            Close Guide & Back to Strategy
                        </button>
                    </div>
                </div>
            </div>
        );
    };

    const StrategySummaryScreen = ({ userId, onDefineStrategy, onProfile, onGuidance }) => {
        const [isModalOpen, setIsModalOpen] = useState(false);
        const [strategyData, setStrategyData] = useState(loadFromLocal(`strategyData_${userId}`, getInitialStrategyState()));

        // --- REAL-TIME DRAFT STATES ---
        // We load from a "draft" key so your work stays even if you don't click "Anchor"
        const [currentGoalReflection, setCurrentGoalReflection] = useState(loadFromLocal(`draft_goal_${userId}`, '')); 
        const [currentPlanBReflection, setCurrentPlanBReflection] = useState(loadFromLocal(`draft_planB_${userId}`, ''));
        const [currentHotspotColdspot, setCurrentHotspotColdspot] = useState(loadFromLocal(`draft_hc_${userId}`, '')); 
        
        const [isSavingReflection, setIsSavingReflection] = useState(false);
        const [reflectionSaveMessage, setReflectionSaveMessage] = useState('');
        const [historyEntries, setHistoryEntries] = useState(loadFromLocal(`reflectionHistory_${userId}`, []));
        
        // --- REAL-TIME AUTO-SAVE (DRAFTS) ---
        // This effect saves your words as you type, protecting against "brain strain" or lost sessions.
        useEffect(() => {
            saveToLocal(`draft_goal_${userId}`, currentGoalReflection);
            saveToLocal(`draft_planB_${userId}`, currentPlanBReflection);
            saveToLocal(`draft_hc_${userId}`, currentHotspotColdspot);
        }, [currentGoalReflection, currentPlanBReflection, currentHotspotColdspot, userId]);

        const daysOfWeekKeys = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];

        const handleStrategyChange = (e) => {
            const { name, value } = e.target;
            const updatedStrategy = { ...strategyData, [name]: value };
            setStrategyData(updatedStrategy);
            saveToLocal(`strategyData_${userId}`, updatedStrategy);
        };

        const handleSaveReflection = () => {
            if (!userId || (!currentGoalReflection.trim() && !currentPlanBReflection.trim() && !currentHotspotColdspot.trim())) {
                setReflectionSaveMessage("Reflection log cannot be empty. Share your insights!");
                return;
            }

            setIsSavingReflection(true);
            
            try {
                const newReflection = {
                    id: Date.now().toString(), 
                    goalReflectionText: currentGoalReflection.trim(),
                    planBReflectionText: currentPlanBReflection.trim(), // Plan B Anchored!
                    hotspotColdspotReflection: currentHotspotColdspot.trim(),
                    timestamp: new Date().getTime(),
                    reflectionType: "Weekly Check-in"
                };
                
                const updatedHistory = [newReflection, ...historyEntries];
                setHistoryEntries(updatedHistory);
                saveToLocal(`reflectionHistory_${userId}`, updatedHistory);
                
                // Clear Drafts & Fields after a successful Anchor
                setCurrentGoalReflection('');
                setCurrentPlanBReflection('');
                setCurrentHotspotColdspot('');
                removeLocal(`draft_goal_${userId}`);
                removeLocal(`draft_planB_${userId}`);
                removeLocal(`draft_hc_${userId}`);

                setReflectionSaveMessage("Insight anchored successfully üêã");
                
                // (Resetting weekly checks logic remains the same)
                const resetDomains = Object.keys(strategyData.domains).reduce((acc, domainKey) => {
                    const resetChecklist = daysOfWeekKeys.reduce((dAcc, day) => ({ ...dAcc, [day]: false }), {});
                    acc[domainKey] = { ...strategyData.domains[domainKey], dailyChecklist: resetChecklist };
                    return acc;
                }, {});
                const strategyAfterReset = { ...strategyData, domains: resetDomains };
                setStrategyData(strategyAfterReset);
                saveToLocal(`strategyData_${userId}`, strategyAfterReset);

                setTimeout(() => setIsSavingReflection(false), 500); 
                setTimeout(() => setReflectionSaveMessage(''), 3000); 
            } catch (error) {
                setReflectionSaveMessage("Error anchoring insights.");
                setIsSavingReflection(false);
            }
        };

        return (
            <div className="p-4 sm:p-8 max-w-4xl mx-auto bg-white rounded-xl shadow-2xl">
                <WiseWhaleLogo />
                <div className="text-center mb-8">
                    <h1 className="text-4xl font-extrabold text-blue-800">Strategise Dashboard</h1>
                    <p className="text-gray-600 italic">"Find the treasures in your flow."</p>
                </div>

                {/* Primary Navigation Hub */}
                <div className="grid grid-cols-1 sm:grid-cols-3 gap-6 mb-10">
                    <button onClick={onDefineStrategy} className="p-6 bg-yellow-50 border-2 border-yellow-400 rounded-2xl text-yellow-900 font-bold hover:bg-yellow-100 transition-all">Strategy Canvas</button>
                    <button onClick={onProfile} className="p-6 bg-purple-50 border-2 border-purple-400 rounded-2xl text-purple-900 font-bold hover:bg-purple-100 transition-all">Inner Seas Map</button>
                    <button onClick={onGuidance} className="p-6 bg-blue-50 border-2 border-blue-400 rounded-2xl text-blue-900 font-bold hover:bg-blue-100 transition-all">Goal Compass</button>
                </div>
				
       {/* Invocation to the Whale's Wisdom - Restored for Inspiration */}
                <div className="mb-8 p-6 bg-blue-50/50 rounded-2xl border border-blue-100 text-center italic shadow-sm">
                    <h3 className="text-lg font-bold text-blue-800 not-italic mb-2">Invocation to the Whale's Wisdom</h3>
                    <p className="text-gray-600 leading-relaxed">
                        The whale is ancient and wise, a symbol of profound strength and gentle purpose: 
                        Lifting extreme weight with breath, they are playful, savvy, and nurturing as they 
                        make distant, purposeful journeys‚Äîsoaking up the nutritious sun and sea.</p>
                </div>
				
                {/* Reflection Log Section */}
                <div className="p-6 bg-white rounded-2xl border-2 border-amber-100 shadow-inner mb-8">
                    <h2 className="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">Weekly Reflection Log</h2>
                    
                    <TextAreaField 
                        label="Progress on Transition:"
                        value={currentGoalReflection}
                        onChange={(e) => setCurrentGoalReflection(e.target.value)}
                        placeholder="What narratives rose this week?"
                    />
                    
                    <TextAreaField 
                        label="Plan B Evaluation (The Kinder Movement):"
                        value={currentPlanBReflection}
                        onChange={(e) => setCurrentPlanBReflection(e.target.value)}
                        placeholder="If you encountered a cold-spot, how did your Plan B support you?"
                    />
                    
                    <TextAreaField 
                        label="Hot-spot / Cold-spot Observations:"
                        value={currentHotspotColdspot}
                        onChange={(e) => setCurrentHotspotColdspot(e.target.value)}
                        placeholder="Any new insights?"
                    />
                    
                    <button onClick={handleSaveReflection} className="w-full py-4 bg-indigo-600 text-white font-bold rounded-xl shadow-lg hover:bg-indigo-700 transition-all">
                        {isSavingReflection ? 'Logging...' : 'Anchor Weekly Reflection ‚öìÔ∏è'}
                    </button>
                    
                    {reflectionSaveMessage && <p className="text-center mt-2 text-green-600 font-bold">{reflectionSaveMessage}</p>}
                </div>

                {/* VISIBLE HISTORY MAP (Your Wisdom Card) */}
                {historyEntries.length > 0 && (
                    <div className="mt-12">
                        <h3 className="text-2xl font-extrabold text-indigo-800 mb-6 flex items-center gap-2">
                            <span>üìú</span> Reflection History
                        </h3>
                        <div className="space-y-6 max-h-[500px] overflow-y-auto pr-2">
                            {historyEntries.map((entry) => (
                                <div key={entry.id} className="p-6 bg-amber-50/30 border-2 border-amber-100 rounded-3xl shadow-sm hover:shadow-md transition-shadow">
                                    <div className="flex justify-between items-center mb-4 border-b border-amber-100 pb-2">
                                        <span className="text-amber-800 font-bold uppercase tracking-widest text-xs">
                                            {new Date(entry.timestamp).toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
                                        </span>
                                        <span className="text-xl">üêã</span>
                                    </div>
                                    <div className="space-y-4">
                                        {entry.goalReflectionText && (
                                            <div>
                                                <p className="text-xs font-black text-indigo-400 uppercase tracking-tighter">Progress on Transition</p>
                                                <p className="text-slate-700 leading-relaxed mt-1">{entry.goalReflectionText}</p>
                                            </div>
                                        )}
                                        {entry.planBReflectionText && (
                                            <div className="p-3 bg-white rounded-xl border border-amber-100">
                                                <p className="text-xs font-black text-amber-500 uppercase tracking-tighter">Plan B Evaluation</p>
                                                <p className="text-slate-600 italic mt-1">{entry.planBReflectionText}</p>
                                            </div>
                                        )}
                                        {entry.hotspotColdspotReflection && (
                                            <div>
                                                <p className="text-xs font-black text-teal-500 uppercase tracking-tighter">H/C Observations</p>
                                                <p className="text-slate-700 mt-1">{entry.hotspotColdspotReflection}</p>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                )}
                
                {/* Utility Footer Buttons */}
                <div className="mt-12 flex flex-col sm:flex-row gap-4 border-t pt-8">
                    <button onClick={() => window.downloadLocalData()} className="flex-1 py-3 text-teal-700 border-2 border-teal-500 rounded-xl font-bold hover:bg-teal-50 transition-all uppercase text-xs tracking-widest">Download Data Copy</button>
                    <button onClick={() => window.signOutUser()} className="flex-1 py-3 text-orange-700 border-2 border-orange-500 rounded-xl font-bold hover:bg-orange-50 transition-all uppercase text-xs tracking-widest">Log Out</button>
                </div>
            </div>
        );
    };
	


	// START of other large components (included for completeness)

    const DomainMonitor = ({ domainKey, domainData, onDomainMonitorChange, onActionChange }) => {
        const daysOfWeekKeys = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
        const daysOfWeekLabels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
        const domainDetails = STRATEGY_CONTENT[domainData.domainTitle];
        const textClass = domainDetails.text;

        const handleChecklistUpdate = (dayKey) => {
            onDomainMonitorChange(domainKey, dayKey);
        };

        const handleActionPleasedChange = (actionId, value) => {
             onActionChange(domainKey, actionId, 'pleased', value);
        };
        
        const handleActionEvaluationChange = (actionId, value) => {
             onActionChange(domainKey, actionId, 'goalAlignmentEvaluation', value);
        };
        
        const completedDays = daysOfWeekKeys.filter(day => domainData.dailyChecklist[day]).length;

        return (
            <div className="mt-6 pt-4 border-t border-dashed border-gray-300">
                <h4 className={`text-lg font-bold ${textClass} mb-3`}>
                    Weekly Engagement Check for "{domainDetails.title}" ({completedDays} / 7 days)
                </h4>
                <p className="text-sm text-gray-600 mb-4">Mark a day when you consciously engaged with your action plan in this domain.</p>
                
                <div className="flex justify-between items-center max-w-lg mx-auto mb-6">
                    {daysOfWeekKeys.map((dayKey, index) => (
                        <div key={dayKey} className="flex flex-col items-center">
                            <label className="text-xs text-gray-600 mb-1">{daysOfWeekLabels[index]}</label>
                            <input
                                type="checkbox"
                                checked={domainData.dailyChecklist[dayKey]}
                                onChange={() => handleChecklistUpdate(dayKey)}
                                className={`w-6 h-6 ${textClass.replace('text', 'text').replace('-800', '-600')} bg-gray-100 border-gray-300 rounded focus:ring-current`}
                            />
                        </div>
                    ))}
                </div>
                
                {/* New: Are you pleased with your attempt? */}
                <h5 className={`text-md font-bold ${textClass} mt-6 mb-3`}>Are you pleased with your attempt? (Overall Assessment)</h5>
                <div className="flex space-x-6 justify-center mb-6">
                    <label className="flex items-center space-x-2 text-gray-700">
                        <input
                            type="checkbox"
                            checked={domainData.actions.every(a => a.pleased === true)}
                            // Pass null actionId to indicate domain-wide change
                            onChange={() => handleActionPleasedChange(null, true)}
                            className="w-5 h-5 text-green-600 bg-gray-100 border-gray-300 rounded focus:ring-green-500"
                        />
                        <span>Yes, I'm pleased with my effort. (Anchor the success!)</span>
                    </label>
                    <label className="flex items-center space-x-2 text-gray-700">
                        <input
                            type="checkbox"
                            checked={domainData.actions.every(a => a.pleased === false)}
                             // Pass null actionId to indicate domain-wide change
                            onChange={() => handleActionPleasedChange(null, false)}
                            className="w-5 h-5 text-red-600 bg-gray-100 border-gray-300 rounded focus:ring-red-500"
                        />
                        <span>No, it's a zone for deeper exploration. (Time to breathe deep.)</span>
                    </label>
                </div>


                {/* New: Goal Alignment Evaluation */}
                <div className={`p-4 rounded-lg shadow-inner ${domainDetails.color}`}>
                    <h5 className={`text-lg font-bold ${textClass} mb-3`}>Goal Alignment Evaluation:</h5>
                    <p className="text-sm text-gray-700 mb-3">
                        **How are you going with these steps and actions?** Have you detected improvements in your daily rhythms? Are skills and abilities blooming?
                        If they‚Äôre not, **breathe deep**. On the exhale, dive deeper for more details, explore for new approaches. This could be a **proximal zone**, and guidance from someone trusted could help. Recognising these zones is the first stage of change. ..‚ÄúChin up!! eyes on the horizon.‚Äù.. </p>
                    {domainData.actions.map(action => (
                        <TextAreaField
                            key={`eval-${action.id}`}
                            label={`Observations for ${action.label.split(':')[0]}:`}
                            value={action.goalAlignmentEvaluation}
                            onChange={(e) => handleActionEvaluationChange(action.id, e.target.value)}
                            placeholder="Observations Action (e.g., I noticed my energy dipped when I skipped Action 1, but felt aligned when I completed it early)."
                            rows={2}
                            placeholderColor={textClass.replace('text', 'placeholder').replace('-800', '-600/70')}
                        />
                    ))}
                </div>

            </div>
        );
    };

        const DomainSection = ({ domainKey, domainData, onDomainChange, onDomainMonitorChange, onActionChange }) => {
        const domainDetails = STRATEGY_CONTENT[domainData.domainTitle];
        
        // CSS class mapping for the Soft Appearance palette
        const appearanceMap = {
            'physicalFlow': 'domain-physical',
            'productiveCreative': 'domain-productive',
            'tidalConnections': 'domain-relational',
            'cognitiveMental': 'domain-cognitive'
        };
        const softClass = appearanceMap[domainKey] || 'bg-white';
        const { text, border, guidance } = domainDetails;

        const handleChange = (field, value, actionId = null, actionField = null) => {
            let updatedData = { ...domainData };
            if (actionId !== null) {
                updatedData.actions = updatedData.actions.map(action => 
                    action.id === actionId ? { ...action, [actionField]: value } : action
                );
            } else {
                updatedData[field] = value;
            }
            onDomainChange(domainKey, updatedData);
        };

        return (
            <div id={`domain-${domainKey}`} className={`p-6 domain-card shadow-xl mb-12 ${softClass} border-l-8 ${border}`}>
                <h3 className={`text-3xl font-extrabold ${text} mb-4 border-b pb-2`}>{domainData.domainTitle}</h3>
                
                <div className="mb-6 p-4 bg-white/60 backdrop-blur-sm rounded-lg shadow-inner border-l-4 border-dashed border-gray-400">
                    <h4 className="text-lg font-bold text-gray-700 mb-1">Goal Guidance:</h4>
                    <p className="text-gray-600 italic text-sm">{guidance}</p>
                </div>

                <InputField 
                    label="Goal Title:"
                    value={domainData.title}
                    onChange={(e) => handleChange('title', e.target.value)}
                    placeholder="E.g., Raising my physical energy flow"
                />
                
                {/* Priority 4: Sensory Scenery Weaving */}
                <TextAreaField 
                    label="Sensory Scenery (Weekly Check-in):"
                    value={domainData.forecastScenerySensory}
                    onChange={(e) => handleChange('forecastScenerySensory', e.target.value)}
                    placeholder="Describe the sensory experience‚Äîwhat do you see, hear, or feel when this is in flow?"
                    rows={2}
                />

                <h4 className={`text-xl font-bold ${text} mt-6 mb-4 pt-4 border-t border-dotted ${border}`}>Action Plan & Companion</h4>
                
				                {domainData.actions.map((action) => (
                    <div key={action.id} className="p-4 mb-4 border rounded-xl bg-white/80 shadow-sm border-dashed border-gray-300">
                        <p className={`text-sm font-semibold ${text} mb-2`}>{action.label}</p>
                        
                        <InputField 
                            label="Action Step (Plan A):"
                            value={action.summary}
                            onChange={(e) => handleChange('actions', e.target.value, action.id, 'summary')}
                            placeholder="What specific step will you take?"
                        />

                        {/* Motivation Anchor - The 'Easy' Path */}
                        <div className="mt-2 p-3 bg-green-50/50 rounded-lg border border-green-100 mb-3">
                            <InputField 
                                label="What makes this easy? (Motivation Anchor):"
                                value={action.easy} 
                                onChange={(e) => handleChange('actions', e.target.value, action.id, 'easy')}
                                placeholder="What strengths or resources make this step feel accessible?"
                            />
                        </div>

                        {/* Cold-Spot Companion  - The 'Plan B' Path */}
                        <div className="mt-3 p-3 bg-red-50/50 rounded-lg border border-red-100">
                            <InputField 
                                label="Cold-Spot Companion (Plan B):"
                                value={action.hard} 
                                onChange={(e) => handleChange('actions', e.target.value, action.id, 'hard')}
                                placeholder="If a cold-spot rises (resistance), I will..."
                                className="companion-input" 
                            />
                        </div>
                    </div>
                ))}

                
                <DomainMonitor 
                    domainKey={domainKey}
                    domainData={domainData}
                    onDomainMonitorChange={onDomainMonitorChange}
                    onActionChange={onActionChange}
                />
            </div>
        );
    };


	const FullStrategyBuilderScreen = ({ userId, onComplete }) => {
    const initialStrategy = loadFromLocal(`strategyData_${userId}`, getInitialStrategyState());
    const [strategyData, setStrategyData] = useState(initialStrategy);
    
    // --- WEEKLY NUDGE LOGIC ---
    const [showNudge, setShowNudge] = useState(false);
	
	    // --- REAL-TIME AUTO-SAVE (CANVAS DRAFTS) ---
    // This effect ensures that as you define your strategy, every keystroke is captured.
    useEffect(() => {
        if (userId && strategyData) {
            saveToLocal(`strategyData_${userId}`, strategyData);
        }
    }, [strategyData, userId]);

    
    // --- ADD THIS NEW LINE FOR THE TREASURE CHEST ---
    const [isChestOpen, setIsChestOpen] = useState(false); 
    
    useEffect(() => {
        const lastSave = localStorage.getItem('wise_whale_last_save_timestamp');
        if (lastSave) {
            const oneWeek = 7 * 24 * 60 * 60 * 1000;
            if (Date.now() - parseInt(lastSave) > oneWeek) {
                setShowNudge(true);
            }
        }
    }, []);

        const [saveMessage, setSaveMessage] = useState('');
        const [isSaving, setIsSaving] = useState(false);
        const [activeDomain, setActiveDomain] = useState(Object.keys(strategyData.domains)[0]);

        const domainElements = useMemo(() => {
            return Object.values(STRATEGY_CONTENT).map(d => ({
                key: d.key,
                title: d.title.split(' of ')[0], 
                color: d.border.replace('border-', 'border-')
            }));
        }, []);

        const handleStrategyChange = (e) => {
            const { name, value } = e.target;
            
            if (name in strategyData.transitionalGoal) {
                setStrategyData(prev => ({
                    ...prev,
                    transitionalGoal: { ...prev.transitionalGoal, [name]: value }
                }));
            }
        };

        const handleDomainChange = (domainKey, newDomainData) => {
            setStrategyData(prev => ({
                ...prev,
                domains: { ...prev.domains, [domainKey]: newDomainData }
            }));
        };

        const handleDomainMonitorChange = (domainKey, dayKey) => {
            setStrategyData(prev => {
                const newDailyChecklist = {
                    ...prev.domains[domainKey].dailyChecklist,
                    [dayKey]: !prev.domains[domainKey].dailyChecklist[dayKey]
                };
                return {
                    ...prev,
                    domains: {
                        ...prev.domains,
                        [domainKey]: {
                            ...prev.domains[domainKey],
                            dailyChecklist: newDailyChecklist
                        }
                    }
                };
            });
        };

        const handleActionChangeForMonitor = (domainKey, actionId, field, value) => {
            setStrategyData(prev => {
                const domain = prev.domains[domainKey];
                let updatedActions = domain.actions;

                if (field === 'pleased' && actionId === null) {
                    // This handles the overall Yes/No checkbox in the monitor
                    updatedActions = domain.actions.map(action => ({ ...action, pleased: value }));
                } else {
                    updatedActions = domain.actions.map(action => 
                        action.id === actionId ? { ...action, [field]: value } : action
                    );
                }

                return {
                    ...prev,
                    domains: {
                        ...prev.domains,
                        [domainKey]: {
                            ...domain,
                            actions: updatedActions
                        }
                    }
                };
            });
        };

        const scrollToDomain = (domainKey) => {
            const element = document.getElementById(`domain-${domainKey}`);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'start', inline: 'nearest' });
                setActiveDomain(domainKey);
            }
        };

        const handleSave = (e) => {
            e.preventDefault();
            setIsSaving(true);
            setSaveMessage('');

            try {
                const dataToSave = { 
                    ...strategyData, 
                    lastUpdated: new Date().toISOString(),
                };
                saveToLocal(`strategyData_${userId}`, dataToSave);

                setTimeout(() => {
                    setIsSaving(false);
                    setSaveMessage("Strategy saved successfully! Your Wise Whale Plan is anchored.");
                    setTimeout(() => setSaveMessage(''), 3000);
                }, 500);

            } catch (error) {
                console.error("Error saving strategy:", error);
                setIsSaving(false);
                setSaveMessage("Error saving strategy. Check console for details.");
            }
        };

		        return (
            <div className="p-4 sm:p-8 max-w-4xl mx-auto bg-white rounded-xl shadow-2xl">
                {/* 1. The Anchor Icon */}
                <WiseWhaleLogo />
                
                {/* 2. The Gentle Nudge */}
                {showNudge && (
                    <div className="mb-8 p-6 bg-indigo-50 border-l-4 border-indigo-400 rounded-2xl shadow-sm">
                        <p className="text-indigo-800 font-medium italic text-lg text-center">
                            "It has been a week since your last deep dive. There is no rush, 
                            but perhaps now is a treasurable time for reflection?"
                        </p>
                        <div className="text-center mt-2">
                            <button 
                                onClick={() => setShowNudge(false)} 
                                className="text-xs text-indigo-400 uppercase tracking-widest font-bold hover:text-indigo-600 transition-colors"
                            >
                                Dismiss Nudge
                            </button>
                        </div>
                    </div>
                )}

                {/* 3. The Centered Golden Heading */}
                <div className="text-center mb-12">
                    <h1 className="text-4xl font-extrabold text-amber-500 mb-2 border-b-2 border-amber-100 pb-4 inline-block">
                        Strategy Canvas üêã
                    </h1>
                    <p className="text-gray-500 italic mt-2">
                        "Breathe deep and write direct... find the treasures in your flow."
                    </p>
                </div>

                {/* 4. The Reflection Chest (Corrected Logic) */}
                <div className="mb-12">
                    <button 
                        type="button"
                        onClick={() => setIsChestOpen(!isChestOpen)}
                        className="w-full py-4 bg-amber-50 border-2 border-amber-200 rounded-2xl text-amber-800 font-bold flex items-center justify-center gap-3 hover:bg-amber-100 transition-all shadow-sm"
                    >
                        <span>{isChestOpen ? 'Close the Reflection Chest' : 'Open the Reflection Chest when ready for deeper self-exploration'}</span>
                        <span className="text-xl">{isChestOpen ? '‚ú®' : 'üíé'}</span>
                    </button>

                    {isChestOpen && (
                        <div className="mt-4 p-8 bg-white border-2 border-amber-100 rounded-3xl shadow-xl">
                            <h3 className="text-xl font-extrabold text-amber-600 mb-6 border-b border-amber-50 pb-2">
                                Treasurable Observation Questions
                            </h3>
                            <div className="grid md:grid-cols-2 gap-x-8 gap-y-4 text-sm text-slate-600 leading-relaxed">
                                <p>‚Ä¢ Internal dialogue: Was it helpful, harsh, or curious?</p>
                                <p>‚Ä¢ Your tolerance for ambiguity or discomfort (did you breathe through it?)</p>
                                <p>‚Ä¢ Biases identified or acting outside your comfort zone.</p>
                                <p>‚Ä¢ Insights gained from participating.</p>
                                <p>‚Ä¢ Balance of Pessimism vs. Optimism.</p>
                                <p>‚Ä¢ Balance of Positive vs. Negative expectations.</p>
                                <p>‚Ä¢ Self vs. Others orientation (over-giving or under-giving?)</p>
                                <p>‚Ä¢ Recognizing Similarities vs. Differences.</p>
                                <p>‚Ä¢ Processing style: Visual, Kinesthetic, or Auditory?</p>
                                <p>‚Ä¢ Frame of reference: Emotional, Thinking, or Imaginative?</p>
                                <p>‚Ä¢ Generalizing vs. developing beliefs from evidence.</p>
                                <p>‚Ä¢ Distortions: Did the mind jump to conclusions?</p>
                                <p>‚Ä¢ Deletions: What was unconsciously left out?</p>
                                <p>‚Ä¢ Abstract vs. Concrete thinking zones.</p>
                                <p>‚Ä¢ Avoidance vs. Pro-activity.</p>
                                <p>‚Ä¢ All-or-nothing view vs. Options.</p>
                                <p>‚Ä¢ Good times to be Focused vs. Diffused.</p>
                            </div>
                            <p className="mt-8 text-center italic text-amber-500 font-medium font-serif">
                                "Take your time with these... let the answers rise like treasures to the surface."
                            </p>
                        </div>
                    )}
                </div>

                <form onSubmit={handleSave}>
                    {/* Transitional Goal Section */}
                    <div id="transitional-goal" className="mb-10 p-6 bg-blue-50 rounded-xl shadow-lg border-l-4 border-blue-500">
                        <h2 className="text-2xl font-bold text-blue-700 mb-4">I. Transitional Goal  (Set your coordinates)</h2>
                        <TextAreaField 
                            label="1. Current Position (Where are you now?):"
                            name="current"
                            value={strategyData.transitionalGoal.current}
                            onChange={handleStrategyChange}
                            placeholder="Briefly describe your current situation or challenge‚Äîthe waters you are currently swimming in."
                            placeholderColor="placeholder-blue-600/70"
                        />
                        <TextAreaField 
                            label="2. Potential Goal (Where are you aiming to be?):"
                            name="potential"
                            value={strategyData.transitionalGoal.potential}
                            onChange={handleStrategyChange}
                            placeholder="What specific outcome or felt state are you working towards? (Your clear water destination)."
                            placeholderColor="placeholder-blue-600/70"
                        />
                        <TextAreaField 
                            label="3. Position in Change (What stage of change are you at?):"
                            name="position"
                            value={strategyData.transitionalGoal.position}
                            onChange={handleStrategyChange}
                            placeholder="E.g., Determined to change; Aware of the learning process; Already practicing new skills; Satisfied with new approaches."
                            placeholderColor="placeholder-blue-600/70"
                        />
                    </div>

                    {/* Domain Tab Navigation (Sticky for easy access) */}
                    <h2 className="text-2xl font-extrabold text-gray-700 mb-6 border-b pb-2"></h2>
                    <div className="sticky top-0 z-10 bg-white/95 backdrop-blur-sm shadow-md rounded-lg p-2 mb-6">
                        <div className="flex space-x-2 overflow-x-auto pb-1">
                            {domainElements.map((domain) => (
                                <button
                                    key={domain.key}
                                    type="button"
                                    onClick={() => scrollToDomain(domain.key)}
                                    className={`flex-shrink-0 px-3 py-2 text-sm font-semibold rounded-lg transition-all ${
                                        activeDomain === domain.key 
                                            ? `bg-gray-100 ${domain.color} border-2 text-gray-800`
                                            : 'text-gray-500 hover:bg-gray-50'
                                    }`}
                                >
                                    {domain.title}
                                </button>
                            ))}
                        </div>
                    </div>

                    {/* Domain Sections */}
                    {Object.keys(strategyData.domains).map(key => (
                        <DomainSection
                            key={key}
                            domainKey={key}
                            domainData={strategyData.domains[key]}
                            onDomainChange={handleDomainChange}
                            onDomainMonitorChange={handleDomainMonitorChange}
                            onActionChange={handleActionChangeForMonitor}
                        />
                    ))}

                    <div className="mt-8 pt-4 border-t border-gray-200">
                        <button 
                            type="submit"
                            disabled={isSaving}
                            className={`w-full py-4 text-white font-bold rounded-xl shadow-lg transition-all transform hover:scale-[1.005] ${
                                isSaving ? 'bg-gray-400 cursor-not-allowed' : 'bg-indigo-600 hover:bg-indigo-700 active:scale-98'
                            }`}
                        >
                            {isSaving ? 'Anchoring Strategy...' : 'Save Strategy Canvas (Local) & Update Dashboard'}
                        </button>
                        
                        {saveMessage && (
                            <p className={`mt-3 text-center font-semibold ${saveMessage.includes('Error') ? 'text-red-600' : 'text-green-600'}`}>
                                {saveMessage}
                            </p>
                        )}

                        <button
                            type="button"
                            onClick={onComplete}
                            className="w-full py-2 mt-4 text-sm font-medium rounded-xl text-gray-600 bg-gray-100 hover:bg-gray-200 transition-colors border border-gray-300"
                        >
                            Return to Dashboard &rarr;
                        </button>
                    </div>
                </form>
            </div>
        );
    };


        // --- The Main App Component ---
		    const App = ({ initialUserId }) => {
        const userId = initialUserId;
        
        // Priority 1: Force start on the Strategy Canvas
        const [currentPage, setCurrentPage] = useState(SCREENS.FULL_STRATEGY_BUILDER);
        
        useEffect(() => {
            saveToLocal(`currentPage_${userId}`, currentPage);
        }, [currentPage, userId]);

        const handleReturnToSummary = useCallback(() => setCurrentPage(SCREENS.STRATEGY_SUMMARY), []);
        const handleGuidanceReview = useCallback(() => setCurrentPage(SCREENS.GOAL_GUIDANCE), []);
        const handleProfileReview = useCallback(() => setCurrentPage(SCREENS.PROFILE_QUESTIONS), []);
        const handleDefineStrategy = useCallback(() => setCurrentPage(SCREENS.FULL_STRATEGY_BUILDER), []);
        const handleStartApp = useCallback(() => setCurrentPage(SCREENS.STRATEGY_SUMMARY), []); 

        const renderContent = () => {
            switch (currentPage) {
                case SCREENS.WELCOME:
                    return <WelcomeScreen userId={userId} onNext={handleStartApp} />; 
                case SCREENS.PROFILE_QUESTIONS:
                    return <ProfileQuestionsScreen userId={userId} onNext={handleGuidanceReview} />; 
                case SCREENS.GOAL_GUIDANCE:
                    return <GoalGuidanceScreen onNext={handleReturnToSummary} />; 
                case SCREENS.STRATEGY_SUMMARY:
                    return (
                        <StrategySummaryScreen 
                            userId={userId} 
                            onDefineStrategy={handleDefineStrategy} 
                            onProfile={handleProfileReview} 
                            onGuidance={handleGuidanceReview}
                        />
                    ); 
                case SCREENS.FULL_STRATEGY_BUILDER:
                    return <FullStrategyBuilderScreen userId={userId} onComplete={handleReturnToSummary} />; 
                default:
                    return <div className="text-center p-10 text-gray-400">Navigating the currents...</div>;
            }
        };

        return (
            <div className="min-h-screen flex flex-col items-center justify-center p-4">
                {/* Main Content Area */}
                <div className="w-full flex-grow">
                    {renderContent()}
                </div>
                
                {/* Global Footer - Always Visible */}
				  <footer className="w-full max-w-4xl mt-12 pb-8 pt-6 border-t border-gray-200 text-center text-xs text-gray-500 space-y-2">
                    <h3 className="text-sm font-bold text-gray-700">{BUSINESS_DETAILS.name}</h3>
                    <p>{BUSINESS_DETAILS.copyright}</p>
                    <p className="italic font-medium">
                        Disclaimer: This application is general self-help material and not a substitute for personalised therapy.
                    </p>
                    <p className="font-semibold text-gray-400 uppercase tracking-widest">{BUSINESS_DETAILS.address}</p>
                    <p><a href={BUSINESS_DETAILS.website} target="_blank" className="text-blue-500 hover:underline">{BUSINESS_DETAILS.website}</a></p>
                </footer>

            </div>
        );
    };

    // --- FINAL RENDER CALL (CRITICAL) ---
    window.renderAppWithAuth = (userId) => {
        const rootElement = document.getElementById('root');
        if (rootElement && userId) {
            ReactDOM.render(<App initialUserId={userId} />, rootElement);
        } else if (rootElement) {
             ReactDOM.unmountComponentAtNode(rootElement);
        }
    };

    
    </script>

</body>
</html>
