<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strategise for Personal Bests !</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-analytics-compat.js"></script>

    <style>
        /* Apply Inter font and subtle background texture */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9; /* Light gray/blue background */
        }
        
        /* Custom scrollbar for better look (optional, but nice) */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Focus on accessibility and mobile keyboard smoothness */
        input:focus, textarea:focus {
            -webkit-overflow-scrolling: auto; 
            scroll-behavior: auto;
        }
        
        /* Smooth scroll behavior for tab navigation */
        html {
            scroll-behavior: smooth;
        }

        /* Styling to center the sign-in form when it is active */
        #signInWrapper {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f4f7f9;
        }
    </style>

    <script src="https://unpkg.com/react@17/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>

    <div id="signInWrapper" style="display: none;">
        <div class="p-8 max-w-sm w-full bg-white rounded-xl shadow-2xl text-center">
            <h1 class="text-3xl font-extrabold text-indigo-700 mb-6">Strategise for Personal Bests !</h1>
            
            <p id="authError" class="text-sm font-semibold text-red-600 mb-4"></p>
            
            <label for="emailInput" class="block text-left text-sm font-medium text-gray-700 mb-1">Email:</label>
            <input type="email" id="emailInput" required class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition-all mb-4">
            
            <label for="passwordInput" class="block text-left text-sm font-medium text-gray-700 mb-1">Password:</label>
            <input type="password" id="passwordInput" required class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition-all mb-6">
            
            <button id="signInButton" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl shadow-lg hover:bg-indigo-700 transition-colors transform hover:scale-[1.005] active:scale-98">
                Log In to Application
            </button>

            <p class="text-xs text-gray-500 mt-6">
                *Only authorised users can access this tool.*
            </p>
        </div>
    </div>
    
    <div id="root" style="display: none;"></div>
    
    <script>
        // --- Firebase Configuration and Initialization ---
        const firebaseConfig = {
          apiKey: "AIzaSyAVoe4aDzGI4TyoNZNhFAi22mc2iCqAXic",
          authDomain: "cellular-axon-474111-r2.firebaseapp.com",
          projectId: "cellular-axon-474111-r2",
          storageBucket: "cellular-axon-474111-r2.firebasestorage.app",
          messagingSenderId: "745585089161",
          appId: "1:745585089161:web:dcede471d4a7bfd5b60458",
          measurementId: "G-JDV77ZHNP2"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const analytics = firebase.analytics(); // Initialized for compatibility
        
        let authenticatedUserId = null; // Variable to hold the signed-in user ID (email)

        const signInWrapper = document.getElementById('signInWrapper');
        const rootElement = document.getElementById('root');
        const emailInput = document.getElementById('emailInput');
        const passwordInput = document.getElementById('passwordInput');
        const signInButton = document.getElementById('signInButton');
        const errorElement = document.getElementById('authError');


        // --- Firebase Sign-In Logic ---
        signInButton.addEventListener('click', async () => {
            const email = emailInput.value;
            const password = passwordInput.value;
            errorElement.textContent = ''; // Clear previous errors

            if (!email || !password) {
                errorElement.textContent = 'Please enter both email and password.';
                return;
            }
            
            signInButton.disabled = true;

            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                // On success, the auth.onAuthStateChanged listener will handle UI update
            } catch (error) {
                signInButton.disabled = false;
                console.error("Sign-in error:", error.code, error.message);
                
                let userMessage = 'Sign-in failed. Please check your email and password.';
                
                switch (error.code) {
                    case 'auth/user-not-found':
                    case 'auth/wrong-password':
                        userMessage = 'Invalid email or password.';
                        break;
                    case 'auth/invalid-email':
                        userMessage = 'The email address is not valid.';
                        break;
                    default:
                        userMessage = 'An authentication error occurred. Please try again.';
                }
                
                errorElement.textContent = userMessage;
            }
        });

        // --- Authentication State Listener (Handles UI Switch) ---
        auth.onAuthStateChanged((user) => {
            if (user) {
                // User is signed in.
                authenticatedUserId = user.email;
                signInWrapper.style.display = 'none'; // Hide sign-in form
                rootElement.style.display = 'block'; // Show React App
                // Re-render the React app with the new user ID
                window.renderAppWithAuth(authenticatedUserId); 
            } else {
                // User is signed out.
                authenticatedUserId = null;
                signInWrapper.style.display = 'flex'; // Show sign-in form
                rootElement.style.display = 'none'; // Hide React App
                signInButton.disabled = false;
                
                // FIX 2: Reset email and password fields on sign-out
                emailInput.value = '';
                passwordInput.value = '';
            }
        });

        // --- Download Data Copy Logic (Outside of React for ease of use) ---
        // FIX 3: Updated download logic to retrieve all local storage keys associated with the user.
        window.downloadLocalData = function() {
            if (!authenticatedUserId) {
                alert("Cannot download data: User is not signed in.");
                return;
            }
            
            // Get all local storage keys for the signed-in user
            const dataPrefix = 'wise_whale_';
            const userSpecificKeys = Object.keys(localStorage).filter(key => 
                key.startsWith(dataPrefix)
            );
            
            const dataToDownload = {};

            userSpecificKeys.forEach(key => {
                try {
                    const data = localStorage.getItem(key);
                    // Attempt to parse to ensure it's valid JSON before adding
                    dataToDownload[key.replace(dataPrefix, '')] = JSON.parse(data);
                } catch (e) {
                    // If parsing fails, store as raw string or skip. Storing raw string for completeness.
                    dataToDownload[key.replace(dataPrefix, '')] = localStorage.getItem(key);
                }
            });

            // Check if any relevant data was found
            if (Object.keys(dataToDownload).length === 0) {
                alert('There‚Äôs no data to download, please ensure you have used the application!');
                return;
            }
            
            const dataString = JSON.stringify({
                userId: authenticatedUserId,
                downloadTimestamp: new Date().toISOString(),
                localData: dataToDownload
            }, null, 2); // Use 2-space indentation for readability

            const blob = new Blob([dataString], { type: 'application/json' }); 
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            
            const date = new Date().toISOString().slice(0, 10).replace(/-/g, '');
            // Include user part of email in filename
            const userHandle = authenticatedUserId.split('@')[0];
            a.download = `StrategiseData-${userHandle}-${date}.json`; 
            
            document.body.appendChild(a);
            a.click();
            
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            console.log('Local data download initiated.');
        };
        
        // Expose the sign out function globally so the React app can call it
        window.signOutUser = function() {
            auth.signOut().then(() => {
                // Sign-out successful. The onAuthStateChanged listener will update the UI.
            }).catch((error) => {
                console.error("Sign Out Error:", error);
            });
        };

    </script>


    <script type="text/babel">
    const { useState, useEffect, useCallback, useMemo, useRef } = React;
    
    // --- LOCAL STORAGE UTILITIES ---
    const DEFAULT_USER_ID = 'wise_whale_local_client';
    const LOCAL_STORAGE_PREFIX = 'wise_whale_';
    
    // ... (rest of your original Local Storage Utilities remain unchanged) ...

    const saveToLocal = (key, data) => {
        try {
            localStorage.setItem(LOCAL_STORAGE_PREFIX + key, JSON.stringify(data));
        } catch (error) {
            console.error("Error saving to Local Storage:", error);
        }
    };

    const loadFromLocal = (key, defaultValue = null) => {
        try {
            const stored = localStorage.getItem(LOCAL_STORAGE_PREFIX + key);
            return stored ? JSON.parse(stored) : defaultValue;
        } catch (error) {
            console.error("Error loading from Local Storage:", error);
            return defaultValue;
        }
    };
    
    const removeLocal = (key) => {
        try {
            localStorage.removeItem(LOCAL_STORAGE_PREFIX + key);
        } catch (error) {
            console.error("Error removing from Local Storage:", error);
        }
    };

    // --- Business Details & States ---
    const BUSINESS_DETAILS = {
        name: "WISE WHALE PSYCHOTHERAPY",
        email: "connect@wisewhalepsychotherapy.com",
        address: "Gold Coast Queensland Australia 4215",
        website: "https://wisewhalehypnotherapy.wisewhalepsychotherapy.com/",
        copyright: "Copyright ¬©Ô∏è WISE WHALE PSYCHOTHERAPY 2025. All rights reserved."
    };
    
    const SCREENS = {
        WELCOME: 'welcome', 
        PROFILE_QUESTIONS: 'profileQuestions', 
        GOAL_GUIDANCE: 'goalGuidance', 
        STRATEGY_SUMMARY: 'strategySummary', 
        FULL_STRATEGY_BUILDER: 'fullStrategyBuilder',
    };
    
    // ... (rest of your original STRATEGY_CONTENT, getInitialDomainState, getInitialStrategyState remains unchanged) ...
    // Note: I am omitting the large component bodies here for brevity, assuming they are placed directly here.

    const initialActionState = { 
        summary: '', 
        easy: '', 
        hard: '', 
        helpful: '', 
        pleased: null, 
        goalAlignmentEvaluation: '' 
    };
    
    // Updated STRATEGY_CONTENT with specific guidance text
    const STRATEGY_CONTENT = {
        'Physical Flow': { 
            title: 'Physical Flow', color: 'bg-green-100', text: 'text-green-800', border: 'border-green-400', key: 'physicalFlow',
            guidance: "Focus on your relationship with your body, movement, and environment. Think about kinetic awareness, establishing consistent daily rhythms, and how your physical space supports (or hinders) your energy."
        },
        'Productive & Creative Currents': { 
            title: 'Productive & Creative Currents', color: 'bg-yellow-100', text: 'text-yellow-800', border: 'border-yellow-400', key: 'productiveCreative',
            guidance: "This domain addresses how you manage time, set priorities, and channel your energy into meaningful work or creative expression. The goal is to find your 'flow state'‚Äîthat balance of challenge and skill."
        },
        'Tidal Connections of Inter/Intrapersonal Relationships': { 
            title: 'Tidal Connections of Inter/Intrapersonal Relationships', color: 'bg-blue-100', text: 'text-blue-800', border: 'border-blue-400', key: 'tidalConnections',
            guidance: "Define your relational goals. This includes setting clear boundaries, practicing effective communication, fostering genuine emotional support, and balancing your need for connection with your need for personal space."
        },
        'Cognitive & Mental Depth & Agility': { 
            title: 'Cognitive & Mental Depth & Agility', color: 'bg-indigo-100', text: 'text-indigo-800', border: 'border-indigo-400', key: 'cognitiveMental',
            guidance: "Focus on metacognition (thinking about thinking). Goals here involve emotional regulation, managing stress responses, recognizing cognitive distortions, and developing mental resilience and adaptability."
        },
    };

    const getInitialDomainState = (title, key) => ({
        domainTitle: title,
        domainKey: key,
        title: '', 
        successCriteria: '', 
        forecastScenerySensory: '', 
        effects: '',
        actions: [
            { ...initialActionState, id: 1, label: 'Action 1: Define what you will do.' },
            { ...initialActionState, id: 2, label: 'Action 2: Define what you will do.' },
            { ...initialActionState, id: 3, label: 'Action 3: Define what you will do.' },
        ],
        dailyChecklist: { mon: false, tue: false, wed: false, thu: false, fri: false, sat: false, sun: false },
    });
    
    const getInitialStrategyState = () => ({
        preferredName: '',
        themeTitle: '',
        date: new Date().toISOString().substring(0, 10), 
        transitionalGoal: { current: '', potential: '', position: '' },
        domains: {
            physicalFlow: getInitialDomainState(STRATEGY_CONTENT['Physical Flow'].title, STRATEGY_CONTENT['Physical Flow'].key),
            productiveCreative: getInitialDomainState(STRATEGY_CONTENT['Productive & Creative Currents'].title, STRATEGY_CONTENT['Productive & Creative Currents'].key),
            tidalConnections: getInitialDomainState(STRATEGY_CONTENT['Tidal Connections of Inter/Intrapersonal Relationships'].title, STRATEGY_CONTENT['Tidal Connections of Inter/Intrapersonal Relationships'].key),
            cognitiveMental: getInitialDomainState(STRATEGY_CONTENT['Cognitive & Mental Depth & Agility'].title, STRATEGY_CONTENT['Cognitive & Mental Depth & Agility'].key),
        },
        monitoring: {
            weeklyReflection: '',
        }
    });

    const WiseWhaleLogo = () => (
        <svg 
            viewBox="0 0 100 100" 
            className="w-16 h-16 mx-auto mb-4" 
            xmlns="http://www.w3.org/2000/svg"
        >
            <defs>
                <linearGradient id="whaleGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style={{stopColor:'rgb(28, 126, 214)', stopOpacity:1}} />
                    <stop offset="100%" style={{stopColor:'rgb(52, 211, 153)', stopOpacity:1}} />
                </linearGradient>
            </defs>
            <g fill="url(#whaleGradient)">
                <path d="M 30 50 C 35 40, 50 35, 60 40 C 65 45, 65 55, 60 60 C 50 65, 35 60, 30 50 Z" />
                <circle cx="20" cy="50" r="5" />
                <circle cx="30" cy="80" r="5" />
                <circle cx="50" cy="90" r="5" />
                <circle cx="70" cy="80" r="5" />
                <circle cx="80" cy="50" r="5" />
                <circle cx="70" cy="20" r="5" />
                <circle cx="50" cy="10" r="5" />
                <circle cx="30" cy="20" r="5" />
                <path d="M 25 50 Q 40 50, 50 50 L 50 50 Q 60 50, 75 50" stroke="url(#whaleGradient)" strokeWidth="5" fill="none" strokeLinecap="round"/>
                <path d="M 50 10 L 40 40 L 60 40 L 50 10" opacity="0.1"/> 
                <path d="M 50 90 L 40 60 L 60 60 L 50 90" opacity="0.1"/> 
            </g>
        </svg>
    );
    
    const InputField = ({ label, type = 'text', value, onChange, required, maxLength, placeholder, rows = 1, name, placeholderColor = 'placeholder-gray-400' }) => (
        <div className="mb-4">
            <label className="block text-left text-sm font-medium text-gray-700 mb-1">{label}</label>
            {rows > 1 ? (
                <textarea
                    name={name}
                    rows={rows}
                    value={value || ''}
                    onChange={onChange}
                    required={required}
                    maxLength={maxLength}
                    placeholder={placeholder}
                    className={`w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition-all resize-y ${placeholderColor}`}
                />
            ) : (
                <input
                    type={type}
                    name={name}
                    value={value || ''}
                    onChange={onChange}
                    required={required}
                    maxLength={maxLength}
                    placeholder={placeholder}
                    className={`w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition-all ${placeholderColor}`}
                />
            )}
        </div>
    );

    const TextAreaField = (props) => <InputField {...props} rows={props.rows || 3} type="textarea" />;
    
    // --- NEW: Welcome Screen Component (Reduced content as main content moved) ---
    const WelcomeScreen = ({ userId, onNext }) => {
        const [strategyInfo, setStrategyInfo] = useState(loadFromLocal(`strategyData_${userId}`, getInitialStrategyState()));
        
        const handleChange = (e) => {
            const { name, value } = e.target;
            setStrategyInfo(prev => ({
                ...prev,
                [name]: value
            }));
        };

        const handleNext = () => {
            saveToLocal(`strategyData_${userId}`, strategyInfo);
            onNext();
        }

        return (
            <div className="p-4 sm:p-8 max-w-4xl mx-auto bg-white rounded-xl shadow-2xl">
                <WiseWhaleLogo />
                <h1 className="text-4xl font-extrabold text-blue-800 mb-2 border-b pb-2 text-center">Wise Whale Psychotherapy</h1>
                
                <div className="text-center mb-8 p-4 bg-blue-50 rounded-lg border-l-4 border-blue-400">
                    <p className="text-xl font-semibold text-blue-800 mb-4">
                        Strategise for Personal Best‚Äôs Application
                    </p>
                    <p className="text-gray-700 text-sm leading-relaxed">
                        **Welcome!** This screen collects the initial data needed to start your Strategy Builder. 
                    </p>
                </div>
                
                <h2 className="text-2xl font-bold text-gray-700 mb-4 border-b pb-2">Your Initial Focus</h2>
                <InputField
                    label="Your Preferred Name:"
                    name="preferredName"
                    value={strategyInfo.preferredName}
                    onChange={handleChange}
                    placeholder="Enter the name you'd like to be called."
                    rows={1}
                />
                <InputField
                    label="Title: Overall Theme of Transition you‚Äôd like to focus on:"
                    name="themeTitle"
                    value={strategyInfo.themeTitle}
                    onChange={handleChange}
                    placeholder="E.g., Career Change, Health Focus, Boundary Setting, Finding Flow."
                    rows={1}
                />
                <InputField
                    label="Date:"
                    name="date"
                    type="date"
                    value={strategyInfo.date}
                    onChange={handleChange}
                    placeholder=""
                    rows={1}
                />
                
                <p className="text-sm text-gray-500 mt-8 mb-4">
                    *(These details will populate your Strategise Dashboard.)*
                </p>

                <button 
                    onClick={handleNext}
                    className="w-full py-4 mt-4 bg-indigo-600 text-white font-bold rounded-xl shadow-lg hover:bg-indigo-700 transition-colors transform hover:scale-[1.005] active:scale-98"
                >
                    Dive into the Strategy Dashboard &rarr;
                </button>

                {/* Simplified Legal Footer for this screen */}
                <div className="mt-8 pt-6 border-t border-gray-200 text-center text-xs text-gray-500 space-y-2">
                    <p>{BUSINESS_DETAILS.copyright}</p>
                </div>
            </div>
        );
    };

    const profileQuestionsStructure = {
        hotspots: [
            { key: 'freshAir', label: 'Where do you go for fresh air and a fulfilling breath?' },
            { key: 'sunlitPlaces', label: 'What are your favorite sunlit places in the morning, noon, and night?' },
            { key: 'positiveRoutine', label: 'What positive routines or habits do you maintain consistently?' },
            { key: 'emotionalSupport', label: 'Who or what provides you with genuine emotional support and safety?' },
            { key: 'physicalActivity', label: 'What physical activity or movement brings you joy and energy?' },
            { key: 'mindfulPractices', label: 'Which mindful practices (meditation, breathing, etc.) help you ground yourself?' },
            { key: 'creativeOutlets', label: 'What creative outlets or hobbies allow you to express yourself freely?' },
            { key: 'safeSpaces', label: 'Describe your most secure and comforting physical environment (safe space).' },
            { key: 'selfCompassion', label: 'In what ways do you consistently show yourself kindness and self-compassion?' },
            { key: 'meaningfulWork', label: 'What aspects of your work or daily tasks feel purposeful and meaningful?' },
            { key: 'qualitySleep', label: 'What conditions help you achieve quality, restorative sleep?' },
            { key: 'nutritiousFood', label: 'What types of nutritious foods do you prioritize for energy and well-being?' },
            { key: 'natureConnection', label: 'How and where do you connect with nature or the outdoors?' },
            { key: 'financialStability', label: 'What aspects of your financial situation provide you with stability and peace of mind?' },
            { key: 'personalBoundaries', label: 'How do you successfully set and maintain healthy personal boundaries?' },
            { key: 'learningGrowth', label: 'What new skills or knowledge are you actively pursuing for personal growth?' },
            { key: 'spiritualPractices', label: 'Do you have any spiritual or philosophical practices that offer guidance and peace?' },
            { key: 'playfulnessHumor', label: 'Where and when do you allow yourself to be playful and use humor?' },
            { key: 'timeManagement', label: 'What strategies do you use that effectively help you manage your time and priorities?' },
            { key: 'conflictResolution', label: 'How do you approach and successfully resolve interpersonal conflicts?' },
            { key: 'gratitudePractices', label: 'In what form do you practice gratitude or appreciation regularly?' },
            { key: 'restoredEnergy', label: 'What specific activity or person most reliably helps you restore depleted energy?' },
        ],
        coldspots: [
            { key: 'gossip', label: 'Gossip' },
            { key: 'deviceUse', label: 'Device use (excessive or mindless scrolling)' },
            { key: 'procrastination', label: ' Procrastination or avoidance of necessary tasks' },
            { key: 'negativeSelfTalk', label: 'Negative or highly critical self-talk' },
            { key: 'socialWithdrawal', label: 'Excessive social withdrawal or isolation' },
            { key: 'perfectionism', label: 'Paralyzing perfectionism or fear of failure' },
            { key: 'comparisonTrap', label: 'Comparing yourself negatively to others (comparison trap)' },
            { key: 'unhealthyFood', label: 'Consuming unhealthy food or excessive substances' },
            { key: 'sleepDeprivation', label: 'Chronic sleep deprivation or inconsistent sleep schedule' },
            { key: 'clutterDisorganization', label: 'Physical clutter or constant disorganization in your environment' },
            { key: 'unclearBoundaries', label: 'Difficulty setting boundaries, leading to being overextended' },
            { key: 'avoidingConflict', label: 'Avoiding necessary confrontation or conflict resolution' },
            { key: 'financialStress', label: 'Chronic financial worry or impulse spending' },
            { key: 'lackOfPurpose', label: 'Feeling a significant lack of direction or purpose' },
            { key: 'overcommitment', label: 'Taking on too many responsibilities (overcommitment)' },
            { key: 'rumination', label: 'Excessive rumination or worry about past events or the future' },
        ]
    };
    
    // ... (rest of ProfileQuestionsScreen, GoalGuidanceScreen, JournalQuestionsModal remain unchanged) ...

    const ProfileQuestionsScreen = ({ userId, onNext }) => {
        const initialState = { hotspots: {}, coldspots: {} };
        profileQuestionsStructure.hotspots.forEach(q => initialState.hotspots[q.key] = '');
        profileQuestionsStructure.coldspots.forEach(q => initialState.coldspots[q.key] = '');
        
        const loadedData = loadFromLocal(`profileData_${userId}`, initialState);
        const [profileData, setProfileData] = useState(loadedData);
        
        const [isSaving, setIsSaving] = useState(false);
        const [saveError, setSaveError] = useState(null);

        const handleChange = (section, key, value) => {
            setProfileData(prev => ({
                ...prev,
                [section]: {
                    ...prev[section],
                    [key]: value
                }
            }));
        };

        const handleSave = (e) => {
            e.preventDefault();
            setIsSaving(true);
            setSaveError(null);
            
            try {
                const dataToSave = { 
                    ...profileData, 
                    submissionTimestamp: new Date().toISOString(),
                    recordType: "Initial Intake Profile"
                };
                
                saveToLocal(`profileData_${userId}`, dataToSave);
                
                setTimeout(() => {
                    setIsSaving(false);
                    onNext(); 
                }, 500);

            } catch (error) {
                console.error("Error writing profile document: ", error);
                setSaveError(`Failed to save data. Error: ${error.message}`);
                setIsSaving(false);
            }
        };

        return (
            <div className="p-4 sm:p-8 max-w-4xl mx-auto bg-white rounded-xl shadow-2xl">
                <h1 className="text-4xl font-extrabold text-blue-800 mb-1 border-b pb-2"> Profile: Your Inner Seas Map</h1>
                <p className="text-gray-600 mb-8">
                    This categorical section helps you build a <strong>definitive self-awareness map</strong>. By charting your energy decisively, and with authority, you can navigate your journey with greater wisdom. (Data is stored only on this browser/device.)
                </p>

                <form onSubmit={handleSave}>
                    <div className="bg-green-50 p-6 rounded-xl shadow-inner mb-10 border border-green-200">
                        <h2 className="text-3xl font-bold text-green-700 mb-4">Hotspots (Energy & Deep Support) üåä</h2>
                        <p className="text-gray-700 italic mb-4">These are the currents that lift you. Describe them in detail to anchor their power.</p>
                        {profileQuestionsStructure.hotspots.map(({ key, label }) => (
                            <TextAreaField 
                                key={key} 
                                label={label} 
                                value={profileData.hotspots[key]} 
                                onChange={(e) => handleChange('hotspots', key, e.target.value)} 
                                placeholder="Your response here‚Äîthe more detail, the clearer the water." 
                                placeholderColor="placeholder-green-600/70"
                                rows={2}
                            />
                        ))}
                    </div>

                    <div className="bg-red-50 p-6 rounded-xl shadow-inner border border-red-200">
                        <h2 className="text-3xl font-bold text-red-700 mb-4">Cold-spots (Obstacles & Energy Drain) ‚öìÔ∏è</h2>
                        <p className="text-gray-700 italic mb-4">Identify the anchors or leaks. Recognising them is the first step to lifting them.</p>
                        {profileQuestionsStructure.coldspots.map(({ key, label }) => (
                             <TextAreaField 
                                key={key} 
                                label={`Do you detect and would like to eradicate: ${label}?`} 
                                value={profileData.coldspots[key]} 
                                onChange={(e) => handleChange('coldspots', key, e.target.value)} 
                                placeholder="Yes/No, and briefly describe the obstacle or how it shows up in your day." 
                                placeholderColor="placeholder-red-600/70"
                                rows={1}
                            />
                        ))}
                    </div>
                    
                    {saveError && <div className="mt-6 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg"><p className="font-semibold">Save Error:</p><p className="text-sm">{saveError}</p></div>}

                    <button 
                        type="submit"
                        disabled={isSaving || !userId}
                        className={`w-full py-4 mt-8 text-white font-bold rounded-xl shadow-lg transition-all transform hover:scale-[1.005] ${
                            isSaving || !userId ? 'bg-gray-400 cursor-not-allowed' : 'bg-indigo-600 hover:bg-indigo-700 active:scale-98'
                        }`}
                    >
                        {isSaving ? 'Charting Your Course...' : 'Save Map & Continue to Goal Guide ‚Üí'}
                    </button>
                </form>
            </div>
        );
    };

    const GoalGuidanceScreen = ({ onNext }) => {
        const smartGoals = ['Specific', 'Measurable', 'Achievable', 'Relevant', 'Time-bound'];
        const dispositions = ['Resilience', 'Emotional Strength', 'Resourcefulness', 'Cognitive Capabilities', 'Reflection', 'Strategic Awareness', 'Relating', 'Social Sophistication'];
        
        const tips = [
            // FIX APPLIED HERE: Replaced string quotes with template literal (backticks) to resolve the syntax error caused by internal quotes.
            { 
                heading: "Use your Wise Voice.", 
                body: `Be realistic. Describe your goals and actions with predictive and permissive sentences to lower the pressure.
			Example of Step: Better Evaluation. "I'm predicting increased tenacity and willpower gradually over the next few weeks with theses 3 actions outlined."` 
            },
            { heading: "Anchor Tasks and Context.", body: "Specify the task and location, timeframes, and perhaps people involved \"Example of Action 1: I will prepare for tenacity and willpower to cope with this specific difficult stage of work. I can set my alarm a few minutes earlier, allowing myself time to acknowledge my priority objectives and visualize myself carrying out tasks successfully with ease and flow.\"" },
            { heading: "Forecast for Breaks.", body: "Have you planned for micro-breaks and macro-breaks? A private moment to breathe (like the whale lifting itself with breath), time in nature, and hopefully a little sunshine. This allows for mental processing and helps you accommodate unforeseen components." },
            { heading: "Clarify Coping Steps.", body: "Start with coping mechanisms you're already aware of, then allow some breathing space for other possibilities to emerge. Allow your thoughts to organize an efficient way to describe your plan." },
            { heading: "Use Directional & Measurable Language.", body: "For example, 'Raising the quantity of genuinely content moments' or 'raising/lowering intensity of...'" },
            { heading: "Prioritize Balance and Health.", body: "Always remember your overarching golden goal: health and fitness. Create balance in your lifestyle by zooming in on each domain. If you notice a fixation or strengths in one or two particular domains, leverage this! How can you see this same 'oomph'? in other your other domains?" },
            { heading: "Acknowledge the Temporary Nature of Efforts.", body: "Use language like: 'For now, I'm doing this and I'm looking at it this way because it helps my motivation.' Remember, everything is impermanent." },
            { heading: "Reflect on Acceptance.", body: "Address limitations, tolerance, trust, and values in your plan. Updated evaluation helps to keep up with our constant companion Change" }, 
            { heading: "Build in Observational Plans.", body: "Create a plan A with a plan B. 'If I notice X about myself (a cold-spot rising), I'm going to take plan A. If I notice Y, I'll call on plan B (a hot-spot action)."},
            { heading: "Sequential Steps.", body: "When writting in each domain, break down the process for each 'Personal Best' into a series of clear, sequential steps. Think of it like a blueprint for navigating your waters. Avoid jargon and focus on practical application." }
        ];

        return (
            <div className="p-4 sm:p-8 max-w-4xl mx-auto bg-white rounded-xl shadow-2xl">
                <h1 className="text-4xl font-extrabold text-blue-800 mb-4 border-b pb-2">Your Goal-Setting Compass üß≠</h1>
                <p className="text-gray-600 mb-8">These notes from Wise Whale are intended as a guide towards safe creation of definitive effective, sustainable goals for your journey ahead. No pressure at all..feeling fantastic!.</p>

                <div className="mb-10 p-6 bg-blue-50 rounded-lg border-l-4 border-blue-400">
                    <h2 className="text-2xl font-bold text-blue-700 mb-4">The S.M.A.R.T. Goal Framework</h2>
                    <p className="text-gray-700 italic mb-4">Let's ensure your goals are well-defined for clear sailing.</p>
                    <ul className="space-y-2">
                        {smartGoals.map((goal, index) => (
                            <li key={index} className="text-gray-700 font-semibold flex items-center">
                                <span className="text-blue-500 mr-3 text-xl">&#9679;</span> **{goal}**
                            </li>
                        ))}
                    </ul>
                </div>
                
                <div className="mb-10 p-6 bg-green-50 rounded-lg border-l-4 border-green-400">
                    <h2 className="text-2xl font-bold text-green-700 mb-4">Developing Core Dispositions</h2>
                    <p className="text-gray-700 mb-4">Let's look for  actions that cultivate these essential inner resources:</p>
                    <div className="grid grid-cols-2 gap-y-3 gap-x-2 text-sm font-medium text-green-800">
                        {dispositions.map((d, index) => (
                            <div key={index} className="flex items-center">
                                <span className="text-green-500 mr-2">&#10003;</span> {d}
                            </div>
                        ))}
                    </div>
                    <p className="text-sm italic text-gray-500 mt-4 font-semibold">
                        A clue to these treasurable dispositions is your <strong>Sensitivity, Inclination, and Ability</strong>‚Äîthe perception, felt impetus, and basic capacity to follow through with a behavior.
                    </p>
                </div>

                <div className="mb-10 p-6 bg-yellow-50 rounded-lg border-l-4 border-yellow-400">
                    <h2 className="text-2xl font-bold text-yellow-700 mb-4">Wise Planning Tips (Clarity is Kindness)</h2>
                    <ul className="space-y-6">
                        {tips.map((tip, index) => (
                            <li key={index} className="text-gray-700 border-b pb-2 last:border-b-0">
                                <h4 className="text-lg font-extrabold text-yellow-700 mb-1">
                                    <span className="font-bold mr-2">{index + 1}.</span> {tip.heading}
                                </h4>
                                <p className="ml-5 mt-1">{tip.body}</p>
                            </li>
                        ))}
                    </ul>

                    <h3 className="text-xl font-bold text-yellow-700 mt-8 mb-4 pt-4 border-t border-yellow-200">Reflect on Acceptance:</h3>
                    <div className="space-y-3 text-gray-700">
                        <p className="font-semibold">&#9679; Which responsibilities and limitations are truly yours? Can you accept them?</p>
                        <p className="font-semibold">&#9679; What are you truly willing to do to move forward?</p>
                        <p className="font-semibold">&#9679; Do you need to redistribute your energy more effectively to improve a range of Personal Best‚Äôs?</p>
                    </div>
                </div>

                <button 
                    onClick={onNext}
                    className="w-full py-4 mt-8 bg-indigo-600 text-white font-bold rounded-xl shadow-lg hover:bg-indigo-700 transition-colors transform hover:scale-[1.005] active:scale-98"
                >
                    I'm Ready to Define My Strategy Canvas &rarr;
                </button>
            </div>
        );
    };

    const JournalQuestionsModal = ({ onClose }) => {
        const observationQuestions = [
            'Use of internal dialogue (Was it helpful, harsh, or curious?)',
            'Your tolerance for ambiguity, frustration, or discomfort (Did you breathe through it?)',
            'Biases identified, times you acted outside of your comfort zone and found the experience more/less comfortable than expected',
            'Insights gained from participating',
            'Times of Pessimism vs. Optimism (What was the balance?)',
            'Times of Positive vs. Negative expectations (Did you allow for the positive?)',
            'Do you easily recognise Self vs. Others Orientation (Are you over-giving/under-giving?)',
            'Do you see things as Similarities vs. Differences',
            'Visual vs. Kinesthetic vs. Auditory (How did you primarily process information?)',
            'Can you recognise different frame of reference‚Äîemotional, thinking, imaginative, internal, and external.',
            'Do you recognise when you are generalizing v‚Äôs developing beliefs from external evidence.', 
            'Distortion (Did your mind jump to conclusions?)',
            'Deletion (What did you unconsciously leave out?)',
            'In your zone is it more helpful to Abstract vs. Concrete',
            'To Avoid vs. Pro-activity',
            'Are you taking an All or nothing view vs. Options',
            'What are good times to be Focused vs. Diffused',
        ];

        const checkInQuestions = [
            'Are= you able to achieve the action again, consistently? If not, what small adjustment is needed?',
            'Are there any steps you would take out for good reason?',
            'Have your actions developed a stronger sense of how you manage your internal and external worlds?',
            "Is looking at the details separately helping you approach life with greater understanding and enjoyment?",
            'Are you going to keep going? What motivates your next breath?',
            'What self-observation would indicate you\'re due for a fresh challenge?',
            'Where to now? What is the next clear water you want to swim into?',
        ];

        return (
            <div className="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-start justify-center p-4 z-50 overflow-y-auto">
                <div className="bg-white rounded-xl shadow-3xl max-w-3xl w-full my-8 p-6 sm:p-8">
                    <div className="flex justify-between items-center border-b pb-3 mb-4">
                        <h2 className="text-3xl font-extrabold text-indigo-700">Wise Whale Weekly Reflection Guide</h2>
                        <button 
                            onClick={onClose}
                            className="text-gray-500 hover:text-gray-800 transition-colors text-3xl font-light"
                        >
                            &times;
                        </button>
                    </div>

                    <div className="mb-8 p-4 bg-purple-50 rounded-lg border-l-4 border-purple-400">
                        <h3 className="text-xl font-bold text-purple-700 mb-3">Self-Observation of Engagement & Evaluations</h3>
                        <ul className="space-y-3">
                            {observationQuestions.map((q, index) => (
                                <li key={`obs-${index}`} className="text-gray-700 flex items-start">
                                    <span className="text-purple-500 mr-2 mt-1">‚Ä¢</span> {q}
                                </li>
                            ))}
                        </ul>
                    </div>

                    <div className="p-4 bg-teal-50 rounded-lg border-l-4 border-teal-400">
                        <h3 className="text-xl font-bold text-teal-700 mb-3">A Final Check-in: Self-Expansion</h3>
                        <ul className="space-y-3">
                            {checkInQuestions.map((q, index) => (
                                <li key={`check-${index}`} className="text-gray-700 flex items-start">
                                    <span className="text-teal-500 mr-2 mt-1">‚Ä¢</span> {q}
                                </li>
                            ))}
                        </ul>
                        <p className="text-sm italic text-gray-500 mt-4 font-semibold">
                            You‚Äôve really explored your strengths, goals, and possibilities today! Well done.
                            Remember: the Wise Whale within you knows the way to clearer waters.
                        </p>
                    </div>

                    <div className="mt-8 text-center">
                        <button 
                            onClick={onClose}
                            className="w-full sm:w-1/2 py-3 bg-indigo-600 text-white font-bold rounded-xl shadow-lg hover:bg-indigo-700 transition-colors transform hover:scale-[1.01] active:scale-98"
                        >
                            Close Guide & Back to Strategy
                        </button>
                    </div>
                </div>
            </div>
        );
    };


    const StrategySummaryScreen = ({ userId, onDefineStrategy, onProfile, onGuidance }) => {
        const [isModalOpen, setIsModalOpen] = useState(false);
        // Load strategy data for display/editing the name/theme/date
        const [strategyData, setStrategyData] = useState(loadFromLocal(`strategyData_${userId}`, getInitialStrategyState()));

        const [currentGoalReflection, setCurrentGoalReflection] = useState(''); 
        const [currentHotspotColdspot, setCurrentHotspotColdspot] = useState(''); 
        const [isSavingReflection, setIsSavingReflection] = useState(false);
        const [reflectionSaveMessage, setReflectionSaveMessage] = useState('');
        
        // Loading History
        const [historyEntries, setHistoryEntries] = useState(loadFromLocal(`reflectionHistory_${userId}`, []));
        
        const daysOfWeekKeys = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];

        // Handler for name/theme/date inputs on this screen
        const handleStrategyChange = (e) => {
            const { name, value } = e.target;
            const updatedStrategy = {
                ...strategyData,
                [name]: value
            };
            setStrategyData(updatedStrategy);
            saveToLocal(`strategyData_${userId}`, updatedStrategy); // Save immediately on change
        };


        const handleSaveReflection = () => {
            if (!userId || (!currentGoalReflection.trim() && !currentHotspotColdspot.trim())) {
                setReflectionSaveMessage("Reflection log cannot be completely empty. Share your insights!");
                return;
            }

            setIsSavingReflection(true);
            setReflectionSaveMessage('');
            
            // Collect the status of all domains for the snapshot
            const domainChecklistSnapshot = Object.keys(strategyData.domains).reduce((acc, domainKey) => {
                // Also capture the 'pleased' and 'goalAlignmentEvaluation' status for all actions
                acc[domainKey] = {
                    dailyChecklist: strategyData.domains[domainKey].dailyChecklist,
                    actionStatus: strategyData.domains[domainKey].actions.map(a => ({ 
                        id: a.id, 
                        pleased: a.pleased, 
                        evaluation: a.goalAlignmentEvaluation 
                    }))
                };
                return acc;
            }, {});

            const transitionalGoalSnapshot = strategyData.transitionalGoal; 

            try {
                const newReflection = {
                    id: Date.now().toString(), 
                    goalReflectionText: currentGoalReflection.trim(),
                    hotspotColdspotReflection: currentHotspotColdspot.trim(), // Save the Coldspot reflection
                    timestamp: new Date().getTime(), 
                    engagementSnapshot: domainChecklistSnapshot, 
                    transitionalGoalSnapshot: transitionalGoalSnapshot, 
                    reflectionType: "Weekly Check-in"
                };
                
                // Correctly updating and saving the history array
                const updatedHistory = [newReflection, ...historyEntries];
                setHistoryEntries(updatedHistory);
                saveToLocal(`reflectionHistory_${userId}`, updatedHistory);
                
                setCurrentGoalReflection('');
                setCurrentHotspotColdspot('');
                setReflectionSaveMessage("Reflection saved successfully! You've anchored your insights. (Local)");
                
                // Clear the checklist state in the main strategy data after saving a reflection
                const resetDomains = Object.keys(strategyData.domains).reduce((acc, domainKey) => {
                    const resetChecklist = daysOfWeekKeys.reduce((dAcc, day) => ({ ...dAcc, [day]: false }), {});
                    acc[domainKey] = {
                        ...strategyData.domains[domainKey],
                        dailyChecklist: resetChecklist
                    };
                    return acc;
                }, {});
                
                const strategyAfterReset = { ...strategyData, domains: resetDomains };
                setStrategyData(strategyAfterReset);
                saveToLocal(`strategyData_${userId}`, strategyAfterReset);


                setTimeout(() => setIsSavingReflection(false), 500); 
                setTimeout(() => setReflectionSaveMessage(''), 3000); 

            } catch (error) {
                console.error("Error writing new reflection document: ", error);
                setReflectionSaveMessage(`Failed to save reflection. Error: ${error.message}`);
                setIsSavingReflection(false);
            }
        };

        // Aggregated Daily Log Calculation for Summary Screen
        const totalPossibleChecks = daysOfWeekKeys.length * Object.keys(strategyData.domains).length;
        let totalCompletedChecks = 0;
        
        Object.values(strategyData.domains).forEach(domain => {
            daysOfWeekKeys.forEach(dayKey => {
                if (domain.dailyChecklist[dayKey]) {
                    totalCompletedChecks += 1;
                }
            });
        });
        
        const progressPercentage = totalPossibleChecks > 0 ? Math.round((totalCompletedChecks / totalPossibleChecks) * 100) : 0;

        const getProgressMessage = (percent) => {
            if (percent === 100) return "Fantastic! Total engagement hit 100%. You've been relentless in your flow!";
            if (percent >= 70) return "Excellent engagement across all domains this week! Keep that momentum flowing into clear waters.";
            if (percent >= 40) return "Great work! You're building a strong habit. Let's aim to lift your efforts, just like the Whale with its breath!";
            return "You're getting started! Every check counts toward your Wise Whale journey. Chin up, eyes on the horizon!";
        };
        
        const displayName = strategyData.preferredName || (userId ? userId.split('@')[0] : 'Client');
        const mockPrimaryGoal = "Define your transitional goal in the Strategy Builder."; 

        return (
            <div className="p-4 sm:p-8 max-w-4xl mx-auto bg-white rounded-xl shadow-2xl">
                <WiseWhaleLogo />
                <div className="flex justify-between items-start mb-2 border-b pb-2">
                    <div>
                        <h1 className="text-4xl font-extrabold text-blue-800">Strategise Dashboard</h1>
                        <p className="text-gray-600">Welcome to your Personal Best's! workspace {displayName}! </p>
                    </div>
                </div>
                
                {/* FIX 4: NEW Button Layout and Text */}
                <div className="flex flex-col space-y-2 mb-8">
                    <p className="text-sm text-gray-600 font-medium">
                        Your Data is stored locally - on your device only.  Download completed strategies to store or share.  Logging out after each use increases privacy and confidentiality.
                    </p>
                    <div className="flex space-x-4">
                        <button
                            onClick={() => window.downloadLocalData()}
                            className="flex-1 py-3 bg-teal-500 text-white font-bold rounded-xl shadow-lg hover:bg-teal-600 transition-colors transform hover:scale-[1.005] active:scale-98"
                        >
                            Download Data Copy
                        </button>
                        <button
                            onClick={() => window.signOutUser()}
                            // FIX 4: Golden Orange color applied
                            className="flex-1 py-3 bg-orange-500 text-white font-bold rounded-xl shadow-lg hover:bg-orange-600 transition-colors transform hover:scale-[1.005] active:scale-98"
                        >
                            Log Out
                        </button>
                    </div>
                </div>
                {/* END FIX 4 */}

                {/* Disclaimer in Prominent Box (New Placement) */}
                <div className="mb-8 p-4 bg-yellow-100 rounded-lg border-l-4 border-yellow-500 shadow-md">
                    <p className="text-sm font-semibold text-gray-700 italic">
                        **Disclaimer:** This application is intended to be general, educational, and experiential self-help material, and not as a regulated health service or a substitute for personalised therapy.
                    </p>
                </div>

                {/* --- Author's Introduction Note and Welcome Message (Moved here) --- */}
                <div className="text-center mb-8 p-4 bg-blue-50 rounded-lg border-l-4 border-blue-400">
                    <h2 className="text-xl font-bold text-blue-800 mb-4">Author's Note (Melinda):</h2>
                    <div className="text-lg italic text-gray-700 leading-relaxed space-y-4 text-left px-2">
                        <p>My philosophy is simple: Everybody can find purpose and fulfillment in pursuit of taking good care. This commitment to self-stewardship is realized across the four key domains of human function: our physical, mental, relational, and creative/productive experiences.</p>
                        
                        <p>This journey is not always straightforward; a large portion of our function operates without ones awareness,  "blinded" until allocated focused time and clear intention illuminate the way. True insight requires separating and recognizing your subconscious thoughts, conscious actions, inner landscape, outer world, memories, and future foresight.</p>
                        
                        <p>More importantly, we need a workable system to fit practice's into our busy lives!</p>
                        
                        <p>By consistently exercising all parts of ourselves, we tone, improve, and maintain them and instill a sense of value. Aiming for your Personal Best's in these areas is not about ego‚Äîit provides the clear, infinite direction for progress.</p>
                        
                        <p>As you engage in self-observation and self-evaluation here, I hope you find S.M.A.R.T. goals and simple steps with actions that are genuinely enjoyable and rewarding. This is the path to less stress, more success.</p>
                        
                        <p>May your striving uncover a wealth of detailed, treasurable insights, enabling you to model your experiences toward deep satisfaction and contentment.</p>
                    </div>

                    <h3 className="text-lg font-bold text-blue-700 mt-6 mb-3">Invocation to the Whale's Wisdom:</h3>
                    <p className="text-base italic text-gray-600 leading-normal">
                        The whale is ancient and wise, a symbol of profound strength and gentle purpose: Lifting extreme weight with breath, they are playful, savvy, and nurturing as they make distant, purposeful journeys‚Äîsoaking up the nutritious sun and sea.
                    </p>
                </div>
                {/* --- END Author's Introduction Note --- */}


                {/* User/Theme Inputs (New Placement) */}
                <div className="mb-8 p-6 bg-gray-50 rounded-xl shadow-inner border border-gray-200">
                    <h2 className="text-xl font-bold text-gray-700 mb-4">Your Current Focus:</h2>
                    <InputField
                        label="Your Preferred Name:"
                        name="preferredName"
                        value={strategyData.preferredName}
                        onChange={handleStrategyChange}
                        placeholder="Enter your preferred name."
                        rows={1}
                    />
                    <InputField
                        label="Overall Theme of Transition you‚Äôd like to focus on:"
                        name="themeTitle"
                        value={strategyData.themeTitle}
                        onChange={handleStrategyChange}
                        placeholder="E.g., Career Change, Health Focus, Boundary Setting."
                        rows={1}
                    />
                    <InputField
                        label="Date:"
                        name="date"
                        type="date"
                        value={strategyData.date}
                        onChange={handleStrategyChange}
                        placeholder=""
                        rows={1}
                    />
                </div>

                {/* Core Action Buttons */}
                <div className="grid sm:grid-cols-3 gap-6 mb-8">
                    <div className="p-4 bg-purple-100 rounded-lg shadow-md">
                        <h3 className="text-lg font-bold text-purple-700 mb-2">Review Profile</h3>
                        <button 
                            onClick={onProfile} 
                            className="mt-2 w-full py-3 bg-purple-600 text-white font-semibold rounded-xl hover:bg-purple-700 transition-colors transform hover:scale-[1.01] active:scale-95"
                        >
                            Hotspots/Coldspots
                        </button>
                    </div>
                    <div className="p-4 bg-blue-100 rounded-lg shadow-md">
                        <h3 className="text-lg font-bold text-blue-700 mb-2">Goal Guidance</h3>
                        <button 
                            onClick={onGuidance}
                            className="mt-2 w-full py-3 bg-blue-600 text-white font-semibold rounded-xl hover:bg-blue-700 transition-colors transform hover:scale-[1.01] active:scale-95"
                        >
                            Planning Framework
                        </button>
                    </div>
                    <div className="p-4 bg-yellow-100 rounded-lg shadow-md border-2 border-yellow-300">
                        <h3 className="text-lg font-bold text-yellow-700 mb-2">Strategy Canvas</h3>
                        <button 
                            onClick={onDefineStrategy} 
                            className="mt-2 w-full py-3 bg-yellow-500 text-white font-semibold rounded-xl hover:bg-yellow-600 transition-colors transform hover:scale-[1.01] active:scale-95"
                        >
                            Define Plan
                        </button>
                    </div>
                </div>

                {/* Engagement Visualization (Waves of Change - Aggregated) */}
                <div className="mb-8 p-6 bg-teal-50 rounded-lg shadow-xl border-l-4 border-teal-500">
                    <h2 className="text-2xl font-bold text-teal-700 mb-3">Your Aggregate Waves of Change üìà</h2>
                    <p className="text-gray-600 mb-4">This bar represents your total action engagement across **all four domains** this week.</p>
                    
                    <div className="bg-teal-200 rounded-full h-8 overflow-hidden shadow-inner relative">
                        <div 
                            className="h-full bg-teal-500 transition-all duration-500 flex items-center justify-end pr-2"
                            style={{ width: `${progressPercentage}%` }}
                        >
                             <svg className="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M19.7 7.3c-.6-.7-1.5-1-2.4-1h-1.6c-1.3 0-2.6.4-3.6 1.2L10 8.9c-.8.6-1.9 1.4-2.8 1.4H4c-1.1 0-2 .9-2 2v2c0 1.1.9 2 2 2h3.2c1.7 0 3.3.6 4.6 1.7l.8.6c.9.7 2.1 1.2 3.4 1.2h1.7c.9 0 1.8-.3 2.5-1 .7-.7 1-1.6 1-2.5V8.8c0-.9-.3-1.8-1-2.5zM17 14h-1.6c-.7 0-1.4-.2-2-.5l-.8-.6c-1.3-1-3-1.6-4.8-1.6H4V9h6.2c1.8 0 3.5-.6 4.8-1.6l.8-.6c.7-.5 1.4-.7 2-.7H17v7z"/>
                            </svg>
                        </div>
                         <span className="absolute inset-0 flex items-center justify-center text-sm font-bold text-teal-900 mix-blend-multiply">
                            {progressPercentage}% Engaged ({totalCompletedChecks} / {totalPossibleChecks} Checks)
                        </span>
                    </div>
                    
                    <p className="mt-4 text-md font-semibold text-teal-800">
                        {getProgressMessage(progressPercentage)}
                    </p>
                </div>


                {/* Primary Transition Goal Check-in */}
                <div className="mb-8 p-6 bg-indigo-50 rounded-lg shadow-md border-l-4 border-indigo-500">
                    <h2 className="text-2xl font-bold text-indigo-700 mb-3">Goal Reflection & Tracking Log üìù</h2>
                    
                    <h3 className="text-xl font-bold text-indigo-700 mt-4 mb-2">1. Weekly Reflection on your Transition</h3>
                    <p className="text-sm font-semibold text-indigo-900 mb-4 border-b border-indigo-200 pb-2">
                        Current Potential Goal: {strategyData?.transitionalGoal?.potential || mockPrimaryGoal}
                    </p>
                    <TextAreaField 
                        label="Reflect on the progress of your primary goal this week:"
                        value={currentGoalReflection}
                        onChange={(e) => { setCurrentGoalReflection(e.target.value); setReflectionSaveMessage(''); }}
                        placeholder="Anchor your thoughts here. What narratives rose? What felt like flow?"
                        placeholderColor="placeholder-indigo-600/70"
                        rows={3}
                    />
                    
                    <h3 className="text-xl font-bold text-teal-700 mt-6 mb-2 border-t pt-4">2. Hot-spot/ Cold-spot Experience Window</h3>
                    <TextAreaField 
                        label="How have you been experiencing hotspot‚Äôs and coldspot‚Äôs, in the past week? Any insights or queries?"
                        value={currentHotspotColdspot}
                        onChange={(e) => { setCurrentHotspotColdspot(e.target.value); setReflectionSaveMessage(''); }}
                        placeholder="E.g., Hotspots are up, especially with exercise. Coldspots decreased since I managed my device use. Insight: I need more clear boundaries."
                        placeholderColor="placeholder-teal-600/70"
                        rows={3}
                    />

                    <div className="flex justify-between items-center mt-6">
                        <button 
                            onClick={handleSaveReflection}
                            disabled={isSavingReflection || (!currentGoalReflection.trim() && !currentHotspotColdspot.trim())}
                            className={`py-3 px-6 text-white rounded-xl shadow-lg transition-colors font-bold ${
                                isSavingReflection ? 'bg-gray-400 cursor-not-allowed' : 'bg-indigo-600 hover:bg-indigo-700'
                            }`}
                        >
                            {isSavingReflection ? 'Logging Insight...' : 'Save Weekly Reflection Log (Local) & Reset Checks'}
                        </button>
                        {reflectionSaveMessage && (
                            <p className={`text-sm font-medium ${reflectionSaveMessage.startsWith('Failed') ? 'text-red-600' : 'text-green-600'}`}>
                                {reflectionSaveMessage}
                            </p>
                        )}
                    </div>
                    
                    {/* Display Reflection History (Simple List for confirmation) */}
                    {historyEntries.length > 0 && (
                        <div className="mt-8 pt-4 border-t border-gray-200">
                            <h4 className="text-lg font-bold text-indigo-700 mb-3">Reflection History ({historyEntries.length} entries)</h4>
                            <div className="space-y-3 max-h-48 overflow-y-auto p-2 bg-gray-50 rounded-lg border">
                                {historyEntries.slice(0, 5).map((entry, index) => (
                                    <div key={entry.id} className="text-sm p-3 border-b last:border-b-0 bg-white shadow-sm rounded">
                                        <p className="font-semibold text-gray-800">Date: {new Date(entry.timestamp).toLocaleDateString()}</p>
                                        <p className="text-gray-600 italic mt-1">Goal: {entry.goalReflectionText.substring(0, 80)}{entry.goalReflectionText.length > 80 ? '...' : ''}</p>
                                        <p className="text-gray-600 italic mt-1">H/C: {entry.hotspotColdspotReflection.substring(0, 80)}{entry.hotspotColdspotReflection.length > 80 ? '...' : ''}</p>
                                    </div>
                                ))}
                                {historyEntries.length > 5 && <p className="text-center text-xs text-gray-500">... and {historyEntries.length - 5} more entries.</p>}
                            </div>
                        </div>
                    )}
                </div>

                
                {/* Updated Business Details and Copyright Footer (New Placement) */}
                <div className="mt-10 pt-6 border-t border-gray-200 text-center text-xs text-gray-500 space-y-2">
                    <h3 className="text-sm font-bold text-gray-700">{BUSINESS_DETAILS.name}</h3>
                    <p>Strategise for Personal Best‚Äôs Application</p>
                    <p>{BUSINESS_DETAILS.copyright}</p>
                    <p>
                        This application is for your personal use only. No part of this application may be reproduced in any form without written permission from the publisher. For information about permission to reproduce selections from this application, please email:
                    </p>
                    <p className="font-semibold text-gray-600">{BUSINESS_DETAILS.email}</p>
                    <p>{BUSINESS_DETAILS.address}</p>
                    <p><a href={BUSINESS_DETAILS.website} target="_blank" className="text-blue-500 hover:text-blue-700">{BUSINESS_DETAILS.website}</a></p>
                    <p>Any questions or insights? {BUSINESS_DETAILS.email}</p>
                    <p className="text-sm text-gray-500 pt-4">Data is maintained locally in your browser.</p>
                </div>
            </div>
        );
    };

    // ... (rest of DomainMonitor, DomainSection, FullStrategyBuilderScreen, and App component remains the same) ...
    // Note: I've included the DomainMonitor, DomainSection, and FullStrategyBuilderScreen for context, but they were not directly modified beyond their inclusion here.
    
    
    
    
    // START of other large components (included for completeness)

    const DomainMonitor = ({ domainKey, domainData, onDomainMonitorChange, onActionChange }) => {
        const daysOfWeekKeys = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
        const daysOfWeekLabels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
        const domainDetails = STRATEGY_CONTENT[domainData.domainTitle];
        const textClass = domainDetails.text;

        const handleChecklistUpdate = (dayKey) => {
            onDomainMonitorChange(domainKey, dayKey);
        };

        const handleActionPleasedChange = (actionId, value) => {
             onActionChange(domainKey, actionId, 'pleased', value);
        };
        
        const handleActionEvaluationChange = (actionId, value) => {
             onActionChange(domainKey, actionId, 'goalAlignmentEvaluation', value);
        };
        
        const completedDays = daysOfWeekKeys.filter(day => domainData.dailyChecklist[day]).length;

        return (
            <div className="mt-6 pt-4 border-t border-dashed border-gray-300">
                <h4 className={`text-lg font-bold ${textClass} mb-3`}>
                    Weekly Engagement Check for "{domainDetails.title}" ({completedDays} / 7 days)
                </h4>
                <p className="text-sm text-gray-600 mb-4">Mark a day when you consciously engaged with your action plan in this domain.</p>
                
                <div className="flex justify-between items-center max-w-lg mx-auto mb-6">
                    {daysOfWeekKeys.map((dayKey, index) => (
                        <div key={dayKey} className="flex flex-col items-center">
                            <label className="text-xs text-gray-600 mb-1">{daysOfWeekLabels[index]}</label>
                            <input
                                type="checkbox"
                                checked={domainData.dailyChecklist[dayKey]}
                                onChange={() => handleChecklistUpdate(dayKey)}
                                className={`w-6 h-6 ${textClass.replace('text', 'text').replace('-800', '-600')} bg-gray-100 border-gray-300 rounded focus:ring-current`}
                            />
                        </div>
                    ))}
                </div>
                
                {/* New: Are you pleased with your attempt? */}
                <h5 className={`text-md font-bold ${textClass} mt-6 mb-3`}>Are you pleased with your attempt? (Overall Assessment)</h5>
                <div className="flex space-x-6 justify-center mb-6">
                    <label className="flex items-center space-x-2 text-gray-700">
                        <input
                            type="checkbox"
                            checked={domainData.actions.every(a => a.pleased === true)}
                            // Pass null actionId to indicate domain-wide change
                            onChange={() => handleActionPleasedChange(null, true)}
                            className="w-5 h-5 text-green-600 bg-gray-100 border-gray-300 rounded focus:ring-green-500"
                        />
                        <span>Yes, I'm pleased with my effort. (Anchor the success!)</span>
                    </label>
                    <label className="flex items-center space-x-2 text-gray-700">
                        <input
                            type="checkbox"
                            checked={domainData.actions.every(a => a.pleased === false)}
                             // Pass null actionId to indicate domain-wide change
                            onChange={() => handleActionPleasedChange(null, false)}
                            className="w-5 h-5 text-red-600 bg-gray-100 border-gray-300 rounded focus:ring-red-500"
                        />
                        <span>No, it's a zone for deeper exploration. (Time to breathe deep.)</span>
                    </label>
                </div>


                {/* New: Goal Alignment Evaluation */}
                <div className={`p-4 rounded-lg shadow-inner ${domainDetails.color}`}>
                    <h5 className={`text-lg font-bold ${textClass} mb-3`}>Goal Alignment Evaluation:</h5>
                    <p className="text-sm text-gray-700 mb-3">
                        **How are you going with these steps and actions?** Have you detected improvements in your daily rhythms? Are skills and abilities blooming?
                        If they‚Äôre not, **breathe deep**. On the exhale, dive deeper for more details, explore for new approaches. This could be a **proximal zone**, and guidance from someone trusted could help. Recognising these zones is the first stage of change. ..‚ÄúChin up!! eyes on the horizon.‚Äù.. </p>
                    {domainData.actions.map(action => (
                        <TextAreaField
                            key={`eval-${action.id}`}
                            label={`Observations for ${action.label.split(':')[0]}:`}
                            value={action.goalAlignmentEvaluation}
                            onChange={(e) => handleActionEvaluationChange(action.id, e.target.value)}
                            placeholder="Observations Action (e.g., I noticed my energy dipped when I skipped Action 1, but felt aligned when I completed it early)."
                            rows={2}
                            placeholderColor={textClass.replace('text', 'placeholder').replace('-800', '-600/70')}
                        />
                    ))}
                </div>

            </div>
        );
    };

    const DomainSection = ({ domainKey, domainData, onDomainChange, onDomainMonitorChange, onActionChange }) => {
        const domainDetails = STRATEGY_CONTENT[domainData.domainTitle];
        const { color, text, border, guidance } = domainDetails;
        const ref = useRef(null);

        const handleChange = (field, value, actionId = null, actionField = null) => {
            let updatedData = { ...domainData };

            if (actionId !== null) {
                updatedData.actions = updatedData.actions.map(action => 
                    action.id === actionId ? { ...action, [actionField]: value } : action
                );
            } else {
                updatedData[field] = value;
            }
            
            onDomainChange(domainKey, updatedData);
        };
        
        // Handler for the 'pleased' and 'goalAlignmentEvaluation' fields from the monitor component
        const handleActionChangeForMonitor = (domainKey, actionId, field, value) => {
             // Logic for overall 'pleased' checkbox handling (applies to all actions in the domain)
            if (field === 'pleased' && actionId === null) {
                const updatedActions = domainData.actions.map(action => ({ ...action, pleased: value }));
                onDomainChange(domainKey, { ...domainData, actions: updatedActions });
                return;
            }
            
            // Logic for individual action updates (like the goal alignment evaluation)
            const updatedActions = domainData.actions.map(action => 
                action.id === actionId ? { ...action, [field]: value } : action
            );
            onDomainChange(domainKey, { ...domainData, actions: updatedActions });
        };


        const getPlaceholderColor = (baseColor) => {
            const colorMatch = baseColor.match(/bg-(\w+)-\d+/);
            if (colorMatch) {
                return `placeholder-${colorMatch[1]}-600/70`;
            }
            return 'placeholder-gray-400';
        };

        return (
            <div id={`domain-${domainKey}`} ref={ref} className={`p-6 rounded-xl shadow-2xl mb-12 ${color} border-l-8 ${border}`}>
                <h3 className={`text-3xl font-extrabold ${text} mb-4 border-b pb-2`}>{domainData.domainTitle}</h3>
                
                {/* Domain-Specific Guidance */}
                <div className="mb-6 p-4 bg-white rounded-lg shadow-inner border-l-4 border-dashed border-gray-400">
                    <h4 className="text-lg font-bold text-gray-700 mb-2">Goal Guidance:</h4>
                    <p className="text-gray-600 italic text-sm">{guidance}</p>
                </div>

                <TextAreaField 
                    label={`Define a goal Title for ${domainData.domainTitle}:`}
                    value={domainData.title}
                    onChange={(e) => handleChange('title', e.target.value)}
                    placeholder="E.g., Raising my physical energy flow"
                    placeholderColor={getPlaceholderColor(color)}
                    rows={1}
                />
                
                <TextAreaField 
                    // Updated Question: What is your Criteria of Success?
                    label="What is your Criteria of Success? (Described as a S.M.A.R.T goal/objective):"
                    name="successCriteria"
                    value={domainData.successCriteria}
                    onChange={(e) => handleChange('successCriteria', e.target.value)}
                    placeholder="How will I know when I have succeeded? What is the Specific, Measurable outcome?"
                    placeholderColor={getPlaceholderColor(color)}
                    rows={2}
                />
                
                <TextAreaField 
                    // Updated Question: Can you forecast the scenery and sensory experience?
                    label="Can you forecast the scenery and sensory experience?"
                    name="forecastScenerySensory"
                    value={domainData.forecastScenerySensory}
                    onChange={(e) => handleChange('forecastScenerySensory', e.target.value)}
                    placeholder="Imagine the scene and describe the positive sensory experience of achieving this goal/action."
                    placeholderColor={getPlaceholderColor(color)}
                    rows={2}
                />
                
                <TextAreaField 
                    label="Anticipated Positive Effects/Consequences (The Ripple Effect):"
                    value={domainData.effects}
                    onChange={(e) => handleChange('effects', e.target.value)}
                    placeholder="What are the ripple effects of achieving this success in your wider life?"
                    placeholderColor={getPlaceholderColor(color)}
                    rows={2}
                />

                <h4 className={`text-xl font-bold ${text} mt-6 mb-4 pt-4 border-t border-dotted ${border}`}>Action Plan (Simple Steps to Take)</h4>
                
                {domainData.actions.map((action) => (
                    <div key={action.id} className={`p-4 mb-4 border rounded-lg bg-white/80 shadow-sm border-dashed ${border}`}>
                        <p className={`text-sm font-semibold ${text} mb-2`}>{action.label}</p>
                        
                        <TextAreaField 
                            label="Summary of the Action:"
                            value={action.summary}
                            onChange={(e) => handleChange('actions', e.target.value, action.id, 'summary')}
                            placeholder="What specific step will I take, and when? (Keep it simple and direct)."
                            placeholderColor={getPlaceholderColor(color)}
                            rows={1}
                        />
                        <TextAreaField 
                            label="What makes this easy? (The hot-spot connection):"
                            value={action.easy}
                            onChange={(e) => handleChange('actions', e.target.value, action.id, 'easy')}
                            placeholder="What resources, skills, or situations support this action? (Anchor your strengths)."
                            placeholderColor={getPlaceholderColor(color)}
                            rows={1}
                        />
                        <TextAreaField 
                            label="What makes this hard? (The cold-spot obstacle):"
                            value={action.hard}
                            onChange={(e) => handleChange('actions', e.target.value, action.id, 'hard')}
                            placeholder="What are the potential obstacles or internal resistance? (Look at the anchors)."
                            placeholderColor={getPlaceholderColor(color)}
                            rows={1}
                        />
                        <TextAreaField 
                            label="How is this action helpful (Self-Compassion & Motivation):"
                            value={action.helpful}
                            onChange={(e) => handleChange('actions', e.target.value, action.id, 'helpful')}
                            placeholder="How will this action contribute to my well-being and progress? (Affirm the value)."
                            placeholderColor={getPlaceholderColor(color)}
                            rows={1}
                        />
                    </div>
                ))}
                
                {/* Domain-Specific Monitor */}
                <DomainMonitor 
                    domainKey={domainKey}
                    domainData={domainData}
                    onDomainMonitorChange={onDomainMonitorChange}
                    onActionChange={handleActionChangeForMonitor}
                />
            </div>
        );
    };

    const FullStrategyBuilderScreen = ({ userId, onComplete }) => {
        const initialStrategy = loadFromLocal(`strategyData_${userId}`, getInitialStrategyState());
        const [strategyData, setStrategyData] = useState(initialStrategy);
        const [saveMessage, setSaveMessage] = useState('');
        const [isSaving, setIsSaving] = useState(false);
        const [activeDomain, setActiveDomain] = useState(Object.keys(strategyData.domains)[0]);

        const domainElements = useMemo(() => {
            return Object.values(STRATEGY_CONTENT).map(d => ({
                key: d.key,
                title: d.title.split(' of ')[0], 
                color: d.border.replace('border-', 'border-')
            }));
        }, []);

        const handleStrategyChange = (e) => {
            const { name, value } = e.target;
            
            if (name in strategyData.transitionalGoal) {
                setStrategyData(prev => ({
                    ...prev,
                    transitionalGoal: { ...prev.transitionalGoal, [name]: value }
                }));
            }
        };

        const handleDomainChange = (domainKey, newDomainData) => {
            setStrategyData(prev => ({
                ...prev,
                domains: { ...prev.domains, [domainKey]: newDomainData }
            }));
        };

        const handleDomainMonitorChange = (domainKey, dayKey) => {
            setStrategyData(prev => {
                const newDailyChecklist = {
                    ...prev.domains[domainKey].dailyChecklist,
                    [dayKey]: !prev.domains[domainKey].dailyChecklist[dayKey]
                };
                return {
                    ...prev,
                    domains: {
                        ...prev.domains,
                        [domainKey]: {
                            ...prev.domains[domainKey],
                            dailyChecklist: newDailyChecklist
                        }
                    }
                };
            });
        };

        const handleActionChangeForMonitor = (domainKey, actionId, field, value) => {
            setStrategyData(prev => {
                const domain = prev.domains[domainKey];
                let updatedActions = domain.actions;

                if (field === 'pleased' && actionId === null) {
                    // This handles the overall Yes/No checkbox in the monitor
                    updatedActions = domain.actions.map(action => ({ ...action, pleased: value }));
                } else {
                    updatedActions = domain.actions.map(action => 
                        action.id === actionId ? { ...action, [field]: value } : action
                    );
                }

                return {
                    ...prev,
                    domains: {
                        ...prev.domains,
                        [domainKey]: {
                            ...domain,
                            actions: updatedActions
                        }
                    }
                };
            });
        };

        const scrollToDomain = (domainKey) => {
            const element = document.getElementById(`domain-${domainKey}`);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'start', inline: 'nearest' });
                setActiveDomain(domainKey);
            }
        };

        const handleSave = (e) => {
            e.preventDefault();
            setIsSaving(true);
            setSaveMessage('');

            try {
                const dataToSave = { 
                    ...strategyData, 
                    lastUpdated: new Date().toISOString(),
                };
                saveToLocal(`strategyData_${userId}`, dataToSave);

                setTimeout(() => {
                    setIsSaving(false);
                    setSaveMessage("Strategy saved successfully! Your Wise Whale Plan is anchored.");
                    setTimeout(() => setSaveMessage(''), 3000);
                }, 500);

            } catch (error) {
                console.error("Error saving strategy:", error);
                setIsSaving(false);
                setSaveMessage("Error saving strategy. Check console for details.");
            }
        };

        return (
            <div className="p-4 sm:p-8 max-w-4xl mx-auto bg-white rounded-xl shadow-2xl">
                <h1 className="text-4xl font-extrabold text-yellow-700 mb-2 border-b pb-2">Strategy Canvas  ‚öìÔ∏è</h1>
                <p className="text-gray-600 mb-8">Define your Transitional Goal and the actions for each Personal Best domain...Breathe deep and write direct..</p>

                <form onSubmit={handleSave}>
                    {/* Transitional Goal Section */}
                    <div id="transitional-goal" className="mb-10 p-6 bg-blue-50 rounded-xl shadow-lg border-l-4 border-blue-500">
                        <h2 className="text-2xl font-bold text-blue-700 mb-4">I. Transitional Goal  (Set your coordinates)</h2>
                        <TextAreaField 
                            label="1. Current Position (Where are you now?):"
                            name="current"
                            value={strategyData.transitionalGoal.current}
                            onChange={handleStrategyChange}
                            placeholder="Briefly describe your current situation or challenge‚Äîthe waters you are currently swimming in."
                            placeholderColor="placeholder-blue-600/70"
                        />
                        <TextAreaField 
                            label="2. Potential Goal (Where are you aiming to be?):"
                            name="potential"
                            value={strategyData.transitionalGoal.potential}
                            onChange={handleStrategyChange}
                            placeholder="What specific outcome or felt state are you working towards? (Your clear water destination)."
                            placeholderColor="placeholder-blue-600/70"
                        />
                        <TextAreaField 
                            label="3. Position in Change (What stage of change are you at?):"
                            name="position"
                            value={strategyData.transitionalGoal.position}
                            onChange={handleStrategyChange}
                            placeholder="E.g., Determined to change; Aware of the learning process; Already practicing new skills; Satisfied with new approaches."
                            placeholderColor="placeholder-blue-600/70"
                        />
                    </div>

                    {/* Domain Tab Navigation (Sticky for easy access) */}
                    <h2 className="text-2xl font-extrabold text-gray-700 mb-6 border-b pb-2">II. Personal Best Domains & Actions (Charting the Course)</h2>
                    <div className="sticky top-0 z-10 bg-white/95 backdrop-blur-sm shadow-md rounded-lg p-2 mb-6">
                        <div className="flex space-x-2 overflow-x-auto pb-1">
                            {domainElements.map((domain) => (
                                <button
                                    key={domain.key}
                                    type="button"
                                    onClick={() => scrollToDomain(domain.key)}
                                    className={`flex-shrink-0 px-3 py-2 text-sm font-semibold rounded-lg transition-all ${
                                        activeDomain === domain.key 
                                            ? `bg-gray-100 ${domain.color} border-2 text-gray-800`
                                            : 'text-gray-500 hover:bg-gray-50'
                                    }`}
                                >
                                    {domain.title}
                                </button>
                            ))}
                        </div>
                    </div>

                    {/* Domain Sections */}
                    {Object.keys(strategyData.domains).map(key => (
                        <DomainSection
                            key={key}
                            domainKey={key}
                            domainData={strategyData.domains[key]}
                            onDomainChange={handleDomainChange}
                            onDomainMonitorChange={handleDomainMonitorChange}
                            onActionChange={handleActionChangeForMonitor}
                        />
                    ))}

                    <div className="mt-8 pt-4 border-t border-gray-200">
                        <button 
                            type="submit"
                            disabled={isSaving}
                            className={`w-full py-4 text-white font-bold rounded-xl shadow-lg transition-all transform hover:scale-[1.005] ${
                                isSaving ? 'bg-gray-400 cursor-not-allowed' : 'bg-indigo-600 hover:bg-indigo-700 active:scale-98'
                            }`}
                        >
                            {isSaving ? 'Anchoring Strategy...' : 'Save Strategy Canvas (Local) & Update Dashboard'}
                        </button>
                        
                        {saveMessage && (
                            <p className={`mt-3 text-center font-semibold ${saveMessage.includes('Error') ? 'text-red-600' : 'text-green-600'}`}>
                                {saveMessage}
                            </p>
                        )}

                        <button
                            type="button"
                            onClick={onComplete}
                            className="w-full py-2 mt-4 text-sm font-medium rounded-xl text-gray-600 bg-gray-100 hover:bg-gray-200 transition-colors border border-gray-300"
                        >
                            Return to Dashboard &rarr;
                        </button>
                    </div>
                </form>
            </div>
        );
    };


    // --- The Main App Component ---
    // NOTE: userId is now passed from the global auth state listener
    const App = ({ initialUserId }) => {
        const userId = initialUserId;
        
        const initialPage = loadFromLocal(`currentPage_${userId}`, SCREENS.STRATEGY_SUMMARY);
        const [currentPage, setCurrentPage] = useState(initialPage);
        
        useEffect(() => {
            saveToLocal(`currentPage_${userId}`, currentPage);
        }, [currentPage, userId]);


        const handleReturnToSummary = useCallback(() => setCurrentPage(SCREENS.STRATEGY_SUMMARY), []);
        const handleGuidanceReview = useCallback(() => setCurrentPage(SCREENS.GOAL_GUIDANCE), []);
        const handleProfileReview = useCallback(() => setCurrentPage(SCREENS.PROFILE_QUESTIONS), []);
        const handleDefineStrategy = useCallback(() => setCurrentPage(SCREENS.FULL_STRATEGY_BUILDER), []);
        const handleStartApp = useCallback(() => setCurrentPage(SCREENS.STRATEGY_SUMMARY), []); 

        const renderContent = () => {
            switch (currentPage) {
                case SCREENS.WELCOME:
                    return <WelcomeScreen userId={userId} onNext={handleStartApp} />; 
                case SCREENS.PROFILE_QUESTIONS:
                    return <ProfileQuestionsScreen userId={userId} onNext={handleGuidanceReview} />; 
                case SCREENS.GOAL_GUIDANCE:
                    return <GoalGuidanceScreen onNext={handleReturnToSummary} />; 
                case SCREENS.STRATEGY_SUMMARY:
                    return (
                        <StrategySummaryScreen 
                            userId={userId} 
                            onDefineStrategy={handleDefineStrategy} 
                            onProfile={handleProfileReview} 
                            onGuidance={handleGuidanceReview}
                        />
                    ); 
                case SCREENS.FULL_STRATEGY_BUILDER:
                    return <FullStrategyBuilderScreen userId={userId} onComplete={handleReturnToSummary} />; 
                default:
                    return <div className="text-center p-10">Starting Application Flow...</div>;
            }
        };

        return (
            <div className="min-h-screen bg-gray-50 flex items-center justify-center p-4">
                <div className="w-full">
                    {renderContent()}
                </div>
            </div>
        );
    };

    // --- FINAL RENDER CALL (CRITICAL) ---
    // Expose the render function globally so the Firebase listener can trigger it.
    window.renderAppWithAuth = (userId) => {
        const rootElement = document.getElementById('root');
        if (rootElement && userId) {
            ReactDOM.render(<App initialUserId={userId} />, rootElement);
        } else if (rootElement) {
             // This case handles when the user signs out, ensuring the React app is unmounted.
             ReactDOM.unmountComponentAtNode(rootElement);
        }
    };
    
    // Initial check: if the Firebase listener fires immediately with a user, it calls renderAppWithAuth.
    // Otherwise, the sign-in screen remains visible.
    
    </script>

</body>
</html>
